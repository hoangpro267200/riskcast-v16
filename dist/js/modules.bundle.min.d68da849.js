function initializeSmartProgressTracking(){const sectionRequiredFields ={'shipping-info': [ 'route', 'transport_mode', 'pol', 'pod', 'shipment-month' ], 'cargo-details': [ 'cargo_type', 'etd', 'eta', 'cargo_value' ], 'seller-info': [ ], 'buyer-info': [ ], 'algorithm-modules': [ ]};function getDropdownValue(fieldId){const hiddenInput = document.getElementById(fieldId + '_input');if (hiddenInput && hiddenInput.value && hiddenInput.value.trim() !== ''){return hiddenInput.value.trim();}const dropdown = document.getElementById(fieldId + '_dropdown');if (!dropdown) return null;const selectedOption = dropdown.querySelector('.dropdown-option.selected');if (selectedOption){const value = selectedOption.getAttribute('data-value');if (value && value.trim() !== '') return value.trim();}const dropdownValue = dropdown.querySelector('.dropdown-value');if (dropdownValue && !dropdownValue.classList.contains('placeholder')){const value = dropdownValue.textContent.trim();if (value && value !== 'Ch∆∞a ch·ªçn' && value !== 'Select' && value.length > 0){return value;}}return null;}function isFieldFilled(fieldId){const input = document.getElementById(fieldId);if (input){if (input.type === 'checkbox'){return input.checked;}const value = input.value ? input.value.trim() : '';if (value === '' || value === '0' || value === '--' || value === 'Ch∆∞a ch·ªçn'){return false;}return value.length > 0;}const dropdownValue = getDropdownValue(fieldId);if (dropdownValue){return dropdownValue.length > 0 && !dropdownValue.includes('placeholder');}return false;}function calculateSectionProgress(sectionId){const section = document.getElementById(sectionId);if (!section) return 0;const requiredFields = sectionRequiredFields[sectionId] || [];if (sectionId === 'algorithm-modules'){const modules = ['use_fuzzy', 'use_forecast', 'use_mc', 'use_var'];const checkedModules = modules.filter(moduleId =>{const checkbox = document.getElementById(moduleId);return checkbox && checkbox.checked;});return checkedModules.length > 0 ? 100 : 0;}if (requiredFields.length === 0){const allInputs = section.querySelectorAll('input:not([type="hidden"]), select, .custom-dropdown');const filledInputs = Array.from(allInputs).filter(input =>{if (input.type === 'checkbox') return input.checked;if (input.value && input.value.trim() !== '' && input.value.trim() !== '0') return true;return false;});return filledInputs.length > 0 ? 50 : 0;}const filledFields = requiredFields.filter(fieldId => isFieldFilled(fieldId));const progress = (filledFields.length / requiredFields.length) * 100;return Math.round(progress);}const completedSectionsTracker = new Set();let allSectionsCompleted = false;let currentActiveSection = null;window.updateProgress = function(){const mainSections = [{id: 'shipping-info', name: 'Th√¥ng Tin V·∫≠n Chuy·ªÉn', index: 0},{id: 'cargo-details', name: 'Chi Ti·∫øt H√†ng H√≥a', index: 1},{id: 'seller-info', name: 'Th√¥ng Tin Ng∆∞·ªùi B√°n', index: 2},{id: 'buyer-info', name: 'Th√¥ng Tin Ng∆∞·ªùi Mua', index: 3},{id: 'algorithm-modules', name: 'M√¥-ƒëun Thu·∫≠t To√°n', index: 4}];let completedSections = 0;mainSections.forEach((section, index) =>{const progress = calculateSectionProgress(section.id);const isCompleted = progress === 100;const wasCompleted = completedSectionsTracker.has(section.id);if (isCompleted){completedSections++;if (!wasCompleted){completedSectionsTracker.add(section.id);showSectionCompletionNotification(section.name);}}else{if (wasCompleted){completedSectionsTracker.delete(section.id);}}updateSectionProgressBar(section, progress, isCompleted, index);});const overallProgress = (completedSections / mainSections.length) * 100;updateHeaderProgress(overallProgress, completedSections);updateStickyProgressBar(overallProgress, completedSections);if (completedSections === 5 && !allSectionsCompleted){allSectionsCompleted = true;showReadyToAnalyzeNotification();}else if (completedSections < 5 && allSectionsCompleted){allSectionsCompleted = false;}};function updateSectionProgressBar(section, progress, isCompleted, index){const sectionElement = document.querySelector(`.progress-section[data-section="${section.id}"]`);const sectionFill = sectionElement?.querySelector('.progress-section-fill');const sectionIndicator = sectionElement?.querySelector('.progress-section-indicator');if (sectionFill){sectionFill.style.width = progress + '%';if (isCompleted && !sectionElement.classList.contains('completed')){sectionElement.classList.add('completed');sectionFill.style.background = 'linear-gradient(90deg, #10B981, #34D399)';sectionFill.style.boxShadow = '0 0 20px rgba(16, 185, 129, 0.6)';if (sectionIndicator){sectionIndicator.innerHTML = '‚úì';sectionIndicator.style.color = '#10B981';sectionIndicator.style.fontSize = '14px';sectionIndicator.style.fontWeight = '700';}}else if (!isCompleted){sectionElement.classList.remove('completed');sectionFill.style.background = progress > 0 ? 'linear-gradient(90deg, rgba(16, 185, 129, 0.5), rgba(16, 185, 129, 0.3))' : 'rgba(255,255,255,0.05)';sectionFill.style.boxShadow = '';if (sectionIndicator){sectionIndicator.innerHTML = String(index + 1).padStart(2, '0');sectionIndicator.style.color = progress > 0 ? 'rgba(255,255,255,0.7)' : 'rgba(255,255,255,0.5)';sectionIndicator.style.fontSize = '11px';sectionIndicator.style.fontWeight = '600';}}}const stickySectionElement = document.querySelector(`#sticky-progress-bar .progress-section[data-section="${section.id}"]`);const stickySectionFill = stickySectionElement?.querySelector('.progress-section-fill');const stickySectionIndicator = stickySectionElement?.querySelector('.progress-section-indicator');if (stickySectionFill){stickySectionFill.style.width = progress + '%';if (isCompleted && !stickySectionElement.classList.contains('completed')){stickySectionElement.classList.add('completed');stickySectionFill.style.background = 'linear-gradient(90deg, #10B981, #34D399)';if (stickySectionIndicator){stickySectionIndicator.innerHTML = '‚úì';stickySectionIndicator.style.color = '#10B981';stickySectionIndicator.style.fontSize = '14px';stickySectionIndicator.style.fontWeight = '700';}}else if (!isCompleted){stickySectionElement.classList.remove('completed');stickySectionFill.style.background = progress > 0 ? 'linear-gradient(90deg, rgba(16, 185, 129, 0.5), rgba(16, 185, 129, 0.3))' : 'rgba(255,255,255,0.05)';if (stickySectionIndicator){stickySectionIndicator.innerHTML = String(index + 1).padStart(2, '0');stickySectionIndicator.style.color = progress > 0 ? 'rgba(255,255,255,0.7)' : 'rgba(255,255,255,0.5)';stickySectionIndicator.style.fontSize = '11px';stickySectionIndicator.style.fontWeight = '600';}}}const sectionNumber = document.querySelector(`#${section.id}.section-number, #${section.id}.section-number-badge`);if (sectionNumber){if (isCompleted){sectionNumber.style.background = '#10B981';sectionNumber.style.color = '#000';sectionNumber.style.fontWeight = '900';sectionNumber.style.boxShadow = '0 0 20px rgba(16, 185, 129, 0.6)';}else if (progress > 0){sectionNumber.style.background = 'rgba(16, 185, 129, 0.5)';sectionNumber.style.color = '#fff';sectionNumber.style.fontWeight = '700';sectionNumber.style.boxShadow = '';}else{sectionNumber.style.background = '';sectionNumber.style.color = '';sectionNumber.style.fontWeight = '';sectionNumber.style.boxShadow = '';}}}function updateHeaderProgress(overallProgress, completedSections){const progressText = document.getElementById('header_progress_text');const sectionsText = document.getElementById('progress-sections-text');if (progressText){progressText.textContent = Math.round(overallProgress) + '%';}if (sectionsText){sectionsText.textContent = `${completedSections}/5 ph·∫ßn ƒë√£ ho√†n th√†nh`;sectionsText.style.color = completedSections === 5 ? '#10B981' : 'rgba(255,255,255,0.6)';sectionsText.style.fontWeight = completedSections === 5 ? '700' : '500';}}function updateStickyProgressBar(overallProgress, completedSections){const stickyProgressText = document.getElementById('sticky-progress-text');const stickySectionsText = document.getElementById('sticky-progress-sections-text');if (stickyProgressText){stickyProgressText.textContent = Math.round(overallProgress) + '%';}if (stickySectionsText){stickySectionsText.textContent = `${completedSections}/5 ph·∫ßn ƒë√£ ho√†n th√†nh`;stickySectionsText.style.color = completedSections === 5 ? '#10B981' : 'rgba(255,255,255,0.7)';stickySectionsText.style.fontWeight = completedSections === 5 ? '700' : '500';}}function showSectionCompletionNotification(sectionName){const container = document.getElementById('progress-notification-container');if (!container) return;const notification = document.createElement('div');notification.className = 'progress-notification completed';notification.innerHTML = ` <div class="notification-content"> <div class="notification-icon">‚úì</div> <div class="notification-text"> <div class="notification-title">ƒê√£ ho√†n th√†nh!</div> <div class="notification-message">Ph·∫ßn "${sectionName}" ƒë√£ ƒë∆∞·ª£c nh·∫≠p ƒë·∫ßy ƒë·ªß</div> </div> </div> `;container.appendChild(notification);setTimeout(() =>{notification.style.animation = 'notificationSlideDown 0.3s reverse forwards';setTimeout(() => notification.remove(), 300);}, 3000);}function showReadyToAnalyzeNotification(){const container = document.getElementById('progress-notification-container');if (!container) return;const notification = document.createElement('div');notification.className = 'progress-notification ready';notification.innerHTML = ` <div class="notification-content"> <div class="notification-icon">üöÄ</div> <div class="notification-text"> <div class="notification-title">S·∫µn S√†ng Ph√¢n T√≠ch!</div> <div class="notification-message">T·∫•t c·∫£ th√¥ng tin ƒë√£ ƒë∆∞·ª£c nh·∫≠p ƒë·∫ßy ƒë·ªß. B·∫°n c√≥ th·ªÉ ch·∫°y ph√¢n t√≠ch ngay b√¢y gi·ªù.</div> </div> </div> `;container.appendChild(notification);setTimeout(() =>{notification.style.animation = 'notificationSlideDown 0.3s reverse forwards';setTimeout(() => notification.remove(), 5000);}, 5000);}function showIncompleteSectionWarning(sectionName, missingFields){const container = document.getElementById('progress-notification-container');if (!container) return;const notification = document.createElement('div');notification.className = 'progress-notification warning';notification.innerHTML = ` <div class="notification-content"> <div class="notification-icon">‚ö†Ô∏è</div> <div class="notification-text"> <div class="notification-title">Ch∆∞a ho√†n th√†nh!</div> <div class="notification-message">Ph·∫ßn "${sectionName}" ch∆∞a ƒë∆∞·ª£c ƒëi·ªÅn ƒë·∫ßy ƒë·ªß. Vui l√≤ng ho√†n th√†nh tr∆∞·ªõc khi ti·∫øp t·ª•c.</div> </div> </div> `;container.appendChild(notification);const section = document.querySelector(`#${sectionName.toLowerCase().replace(/\s+/g, '-')}`);if (section){section.scrollIntoView({behavior: 'smooth', block: 'center'});}setTimeout(() =>{notification.style.animation = 'notificationSlideDown 0.3s reverse forwards';setTimeout(() => notification.remove(), 4000);}, 4000);}function setupNavigationWarnings(){const sectionHeaders = document.querySelectorAll('.section-header');sectionHeaders.forEach(header =>{header.addEventListener('click', function(e){const section = this.closest('.form-section');if (!section) return;const sectionId = section.id;const progress = calculateSectionProgress(sectionId);if (progress < 100 && sectionId !== 'shipping-info'){const sections = ['shipping-info', 'cargo-details', 'seller-info', 'buyer-info', 'algorithm-modules'];const currentIndex = sections.indexOf(sectionId);if (currentIndex > 0){const prevSectionId = sections[currentIndex - 1];const prevProgress = calculateSectionProgress(prevSectionId);if (prevProgress < 100){e.preventDefault();e.stopPropagation();const sectionNames ={'shipping-info': 'Th√¥ng Tin V·∫≠n Chuy·ªÉn', 'cargo-details': 'Chi Ti·∫øt H√†ng H√≥a', 'seller-info': 'Th√¥ng Tin Ng∆∞·ªùi B√°n', 'buyer-info': 'Th√¥ng Tin Ng∆∞·ªùi Mua', 'algorithm-modules': 'M√¥-ƒëun Thu·∫≠t To√°n'};showIncompleteSectionWarning(sectionNames[prevSectionId], []);return false;}}}});});}function setupStickyProgressBar(){const closeBtn = document.getElementById('close-progress-bar');const stickyBar = document.getElementById('sticky-progress-bar');if (closeBtn && stickyBar){closeBtn.addEventListener('click', () =>{stickyBar.classList.add('hidden');setTimeout(() =>{stickyBar.style.display = 'none';}, 300);});}let lastScrollTop = 0;let stickyBarVisible = false;function handleScroll(){const scrollTop = window.pageYOffset || document.documentElement.scrollTop;if (!stickyBar) return;if (scrollTop > 200 && !stickyBarVisible){stickyBar.style.display = 'block';stickyBarVisible = true;}else if (scrollTop <= 200 && stickyBarVisible){stickyBar.style.display = 'none';stickyBarVisible = false;}lastScrollTop = scrollTop;}window.addEventListener('scroll', handleScroll,{passive: true});handleScroll();}let progressUpdateScheduled = false;window.scheduleProgressUpdate = function(){if (progressUpdateScheduled) return;progressUpdateScheduled = true;const runner = () =>{progressUpdateScheduled = false;if (typeof window.updateProgress === 'function'){window.updateProgress();}};if (window.requestAnimationFrame){window.requestAnimationFrame(runner);}else{setTimeout(runner, 16);}};setTimeout(() =>{window.updateProgress();setupNavigationWarnings();setupStickyProgressBar();}, 100);}if (document.readyState === 'loading'){document.addEventListener('DOMContentLoaded', initializeSmartProgressTracking);}else{initializeSmartProgressTracking();}(function(){'use strict';document.addEventListener('DOMContentLoaded', function(){console.log('[AI Chat] DOM loaded, initializing...');const aiToggle = document.getElementById('ai-toggle');const aiPanel = document.getElementById('ai-panel');const aiMinimize = document.getElementById('ai-minimize');const aiInput = document.getElementById('ai-input');const aiSend = document.getElementById('ai-send');const aiMessages = document.getElementById('ai-messages');console.log('[AI Chat Premium] Elements found:',{toggle: !!aiToggle, panel: !!aiPanel, minimize: !!aiMinimize, input: !!aiInput, send: !!aiSend, messages: !!aiMessages});if (aiToggle && aiPanel){console.log('[AI Chat Premium] Initializing premium chat widget...');aiToggle.style.display = 'flex';aiToggle.style.visibility = 'visible';aiToggle.style.opacity = '1';aiPanel.style.display = 'none';aiToggle.addEventListener('click', function(e){e.preventDefault();e.stopPropagation();console.log('[AI Chat Premium] Toggle clicked, opening panel...');aiPanel.style.display = 'flex';aiPanel.style.visibility = 'visible';aiToggle.style.display = 'none';setTimeout(() =>{if (aiInput){aiInput.focus();console.log('[AI Chat Premium] Input focused');}}, 100);});if (aiMinimize){aiMinimize.addEventListener('click', function(e){e.preventDefault();e.stopPropagation();console.log('[AI Chat Premium] Minimize clicked, closing panel...');aiPanel.style.display = 'none';aiPanel.style.visibility = 'hidden';aiToggle.style.display = 'flex';});}else{console.warn('[AI Chat Premium] Minimize button not found!');}if (aiSend && aiInput && aiMessages){const sendMessageNew = async function(){const messageText = aiInput.value.trim();if (!messageText) return;const fragment = document.createDocumentFragment();const userBubble = document.createElement('div');userBubble.className = 'ai-bubble user';userBubble.textContent = messageText;fragment.appendChild(userBubble);const typingBubble = document.createElement('div');typingBubble.className = 'ai-bubble';typingBubble.innerHTML = '<div style="display: flex;gap: 4px;"><div style="width: 6px;height: 6px;background: #00d4aa;border-radius: 50%;animation: typingBounce 1.4s infinite;"></div><div style="width: 6px;height: 6px;background: #00d4aa;border-radius: 50%;animation: typingBounce 1.4s infinite 0.2s;"></div><div style="width: 6px;height: 6px;background: #00d4aa;border-radius: 50%;animation: typingBounce 1.4s infinite 0.4s;"></div></div>';fragment.appendChild(typingBubble);aiMessages.appendChild(fragment);aiInput.value = '';aiMessages.scrollTop = aiMessages.scrollHeight;try{const response = await fetch('/api/ai/chat',{method: 'POST', headers:{'Content-Type': 'application/json'}, body: JSON.stringify({message: messageText, context:{route: document.getElementById('summary-route')?.textContent || 'N/A', cargo: document.getElementById('summary-cargo')?.textContent || 'N/A', container: document.getElementById('summary-container')?.textContent || 'N/A', carrier: document.getElementById('summary-carrier')?.textContent || 'N/A'}})});if (!response.ok){let errorMsg = `API Error: ${response.status}${response.statusText}`;try{const errorData = await response.json();errorMsg = errorData.detail || errorData.message || errorMsg;console.error('[AI Chat Premium] API Error Response:', errorData);}catch (e){const errorText = await response.text().catch(() => '');console.error('[AI Chat Premium] API Error Text:', errorText);errorMsg = errorText || errorMsg;}throw new Error(errorMsg);}const data = await response.json();console.log('[AI Chat Premium] Response data:', data);typingBubble.remove();const aiBubble = document.createElement('div');aiBubble.className = 'ai-bubble';const aiResponse = data.reply || data.response || data.message || 'Xin l·ªói, t√¥i ch∆∞a hi·ªÉu c√¢u h·ªèi c·ªßa b·∫°n.';aiBubble.textContent = aiResponse;aiMessages.appendChild(aiBubble);aiMessages.scrollTop = aiMessages.scrollHeight;}catch (error){console.error('[AI Chat Premium] Error:', error);console.error('[AI Chat Premium] Error message:', error.message);console.error('[AI Chat Premium] Error stack:', error.stack);typingBubble.remove();const errorBubble = document.createElement('div');errorBubble.className = 'ai-bubble';let errorMessage = 'Xin l·ªói, ƒë√£ x·∫£y ra l·ªói khi k·∫øt n·ªëi v·ªõi AI. Vui l√≤ng th·ª≠ l·∫°i sau.';let useHTML = false;const errorMsg = (error.message || '').toLowerCase();if (errorMsg.includes('anthropic_api_key not configured') || errorMsg.includes('api key') || errorMsg.includes('anthropic_api_key') || errorMsg.includes('authentication') || errorMsg.includes('not configured')){errorMessage = '‚ö†Ô∏è <strong>API Key ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh!</strong><br><br>Vui l√≤ng:<br>1. T·∫°o file <code>.env</code> trong th∆∞ m·ª•c g·ªëc<br>2. Th√™m d√≤ng: <code>ANTHROPIC_API_KEY=your_api_key_here</code><br>3. L·∫•y API key t·∫°i: <a href="https: useHTML = true;}else if (errorMsg.includes('401') || errorMsg.includes('Unauthorized')){errorMessage = '‚ùå L·ªói x√°c th·ª±c. Vui l√≤ng ki·ªÉm tra API key trong file .env';}else if (errorMsg.includes('500') || errorMsg.includes('Internal Server')){errorMessage = '‚ö†Ô∏è L·ªói m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i sau.';}else if (errorMsg.includes('Network') || errorMsg.includes('Failed to fetch')){errorMessage = 'üåê L·ªói k·∫øt n·ªëi m·∫°ng. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet.';}else if (errorMsg.includes('API Error')){errorMessage = `‚ùå L·ªói API: ${errorMsg}`;}if (useHTML){errorBubble.innerHTML = errorMessage;errorBubble.style.whiteSpace = 'normal';errorBubble.style.lineHeight = '1.6';}else{errorBubble.textContent = errorMessage;}aiMessages.appendChild(errorBubble);aiMessages.scrollTop = aiMessages.scrollHeight;}};aiSend.addEventListener('click', sendMessageNew);aiInput.addEventListener('keypress', function(e){if (e.key === 'Enter' && !e.shiftKey){e.preventDefault();sendMessageNew();}});console.log('[AI Chat Premium] Send message handlers attached');}}else{console.warn('[AI Chat Premium] Toggle or panel not found, falling back to legacy...');}const chatButton = document.getElementById('chatButton') || document.getElementById('aiChatButton');const chatPopup = document.getElementById('chatPopup') || document.getElementById('aiChatPopup');const chatClose = document.getElementById('chatClose') || document.getElementById('chatCloseBtn');const chatInput = document.getElementById('chatInput');const sendButton = document.getElementById('sendButton') || document.getElementById('chatSendBtn');const chatMessages = document.getElementById('chatMessages');const notificationBadge = document.getElementById('notificationBadge');if (!aiToggle || !aiPanel){if (!chatPopup || !chatInput || !sendButton || !chatMessages){console.warn('[AI Chat] Missing required DOM elements, widget not initialized.');console.warn('[AI Chat] chatPopup:', chatPopup, 'chatInput:', chatInput, 'sendButton:', sendButton, 'chatMessages:', chatMessages);return;}console.log('[AI Chat] Initializing legacy widget...');console.log('[AI Chat] chatButton:', chatButton, 'chatPopup:', chatPopup);let backdrop = document.getElementById('aiChatBackdrop');if (!backdrop){backdrop = document.createElement('div');backdrop.id = 'aiChatBackdrop';backdrop.className = 'ai-chat-backdrop';document.body.appendChild(backdrop);}let savedScrollPosition = 0;let isChatOpen = false;function openChat(e){if (e){e.preventDefault();e.stopPropagation();}if (isChatOpen){return;}console.log('[AI Chat] Opening chat popup...');if (!chatPopup){console.error('[AI Chat] chatPopup is null!');return;}isChatOpen = true;savedScrollPosition = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;const scrollY = window.scrollY;document.body.style.overflow = 'hidden';document.body.style.position = 'fixed';document.body.style.top = `-${scrollY}px`;document.body.style.width = '100%';document.documentElement.style.scrollBehavior = 'auto';if (backdrop){backdrop.classList.add('active');}chatPopup.style.display = 'flex';chatPopup.style.visibility = 'visible';chatPopup.style.opacity = '0';chatPopup.style.zIndex = '99999';chatPopup.style.position = 'fixed';chatPopup.style.top = '50%';chatPopup.style.left = '50%';chatPopup.style.transform = 'translate(-50%, -50%) scale(0.85)';chatPopup.classList.add('active');void chatPopup.offsetHeight;setTimeout(() =>{chatPopup.style.opacity = '1';chatPopup.style.transform = 'translate(-50%, -50%) scale(1)';chatPopup.style.visibility = 'visible';}, 10);if (chatInput){setTimeout(() =>{try{chatInput.focus({preventScroll: true});}catch (e){chatInput.focus();}if (document.body.style.position === 'fixed'){}}, 200);}if (notificationBadge){notificationBadge.style.display = 'none';}console.log('[AI Chat] Chat popup opened successfully');}function closeChat(){console.log('[AI Chat] Closing chat popup...');isChatOpen = false;const bodyTop = document.body.style.top;const scrollY = bodyTop ? parseInt(bodyTop.replace('-', '')) : savedScrollPosition;document.body.style.overflow = '';document.body.style.position = '';document.body.style.top = '';document.body.style.width = '';document.documentElement.style.scrollBehavior = '';setTimeout(() =>{window.scrollTo({top: scrollY || savedScrollPosition, behavior: 'auto'});}, 10);if (chatPopup){chatPopup.classList.remove('active');setTimeout(() =>{chatPopup.style.display = 'none';}, 300);}if (backdrop){backdrop.classList.remove('active');}}if (chatButton){console.log('[AI Chat] Adding click listener to chatButton');chatButton.addEventListener('click', function(e){e.preventDefault();e.stopPropagation();openChat(e);});}else{console.warn('[AI Chat] chatButton not found!');}const aiBot = document.getElementById('aiBot');if (aiBot){console.log('[AI Chat] Adding click listener to 3D bot');aiBot.addEventListener('click', function(e){e.preventDefault();e.stopPropagation();openChat(e);});aiBot.style.cursor = 'pointer';}else{console.warn('[AI Chat] 3D bot (aiBot) not found!');}if (chatClose){chatClose.addEventListener('click', function(e){e.stopPropagation();closeChat();});}document.addEventListener('keydown', function(e){if (e.key === 'Escape' && chatPopup && chatPopup.classList.contains('active')){closeChat();}});if (backdrop){backdrop.addEventListener('click', function(e){e.stopPropagation();closeChat();});}}async function sendMessage(){const messageText = chatInput.value.trim();if (!messageText) return;addMessage(messageText, 'user');chatInput.value = '';sendButton.disabled = true;showTypingIndicator();try{const context ={overall_risk: document.getElementById('overall-risk-index')?.textContent || 'N/A', expected_loss: document.getElementById('expected-loss')?.textContent || 'N/A', reliability: document.getElementById('reliability-score')?.textContent || 'N/A', route: document.getElementById('routeChip')?.textContent || 'N/A', esg_score: document.getElementById('esg-score')?.textContent || 'N/A', climate_hazard_index: document.getElementById('chi-hero-value')?.textContent || 'N/A'};const response = await fetch('/api/ai/chat',{method: 'POST', headers:{'Content-Type': 'application/json'}, body: JSON.stringify({message: messageText, context: context})});if (!response.ok){let errorMsg = `API Error: ${response.status}${response.statusText}`;try{const errorData = await response.json();errorMsg = errorData.detail || errorData.message || errorMsg;console.error('[AI Chat Legacy] API Error Response:', errorData);}catch (e){const errorText = await response.text().catch(() => '');console.error('[AI Chat Legacy] API Error Text:', errorText);errorMsg = errorText || errorMsg;}console.error('[AI Chat Legacy] API Error:', errorMsg);throw new Error(errorMsg);}const data = await response.json();hideTypingIndicator();const aiResponse = data.reply || data.response || data.message || 'Xin l·ªói, t√¥i ch∆∞a hi·ªÉu c√¢u h·ªèi c·ªßa b·∫°n.';addMessage(aiResponse, 'ai');}catch (error){console.error('[AI Chat Legacy] Error:', error);console.error('[AI Chat Legacy] Error message:', error.message);console.error('[AI Chat Legacy] Error stack:', error.stack);hideTypingIndicator();let errorMessage = 'Xin l·ªói, ƒë√£ x·∫£y ra l·ªói khi k·∫øt n·ªëi v·ªõi AI. Vui l√≤ng th·ª≠ l·∫°i sau.';const errorMsg = error.message || '';if (errorMsg.includes('ANTHROPIC_API_KEY not configured') || errorMsg.includes('API key') || errorMsg.includes('ANTHROPIC_API_KEY') || errorMsg.includes('authentication')){errorMessage = '‚ö†Ô∏è API Key ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh!\n\nVui l√≤ng:\n1. T·∫°o file .env trong th∆∞ m·ª•c g·ªëc\n2. Th√™m d√≤ng: ANTHROPIC_API_KEY=your_api_key_here\n3. L·∫•y API key t·∫°i: https:}else if (errorMsg.includes('401') || errorMsg.includes('Unauthorized')){errorMessage = '‚ùå L·ªói x√°c th·ª±c. Vui l√≤ng ki·ªÉm tra API key trong file .env';}else if (errorMsg.includes('500') || errorMsg.includes('Internal Server')){errorMessage = '‚ö†Ô∏è L·ªói m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i sau.';}else if (errorMsg.includes('Network') || errorMsg.includes('Failed to fetch')){errorMessage = 'üåê L·ªói k·∫øt n·ªëi m·∫°ng. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet.';}else if (errorMsg.includes('API Error')){errorMessage = `‚ùå L·ªói API: ${errorMsg}`;}addMessage(errorMessage, 'ai');}finally{sendButton.disabled = false;}}function addMessage(text, sender){const messageDiv = document.createElement('div');messageDiv.className = `message ${sender}`;const avatar = document.createElement('div');avatar.className = 'message-avatar';avatar.textContent = sender === 'ai' ? 'ü§ñ' : 'üë§';const bubble = document.createElement('div');bubble.className = 'message-bubble';bubble.textContent = text;messageDiv.appendChild(avatar);messageDiv.appendChild(bubble);chatMessages.appendChild(messageDiv);scrollToBottom();}function showTypingIndicator(){const indicator = document.createElement('div');indicator.className = 'message ai';indicator.id = 'typingIndicator';const avatar = document.createElement('div');avatar.className = 'message-avatar';avatar.textContent = 'ü§ñ';const typingDiv = document.createElement('div');typingDiv.className = 'message-bubble typing-indicator active';typingDiv.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';indicator.appendChild(avatar);indicator.appendChild(typingDiv);chatMessages.appendChild(indicator);scrollToBottom();}function hideTypingIndicator(){const indicator = document.getElementById('typingIndicator');if (indicator) indicator.remove();}function scrollToBottom(){chatMessages.scrollTop = chatMessages.scrollHeight;}if (sendButton) sendButton.addEventListener('click', sendMessage);if (chatInput){chatInput.addEventListener('keypress', function(e){if (e.key === 'Enter' && !e.shiftKey){e.preventDefault();sendMessage();}});}if (chatPopup){chatPopup.addEventListener('click', function(e){e.stopPropagation();});}});})();class AIAdviserPanel{constructor(){this.panel = null;this.sidebar = null;this.isOpen = false;this.streamingHandler = null;this.currentStreamingMessage = null;this.init();}init(){this.sidebar = document.getElementById('results-ai-chat');if (!this.sidebar && !document.getElementById('ai-panel')){this.createPanel();}if (this.sidebar){this.panel = this.sidebar;if (typeof StreamingHandler !== 'undefined'){this.streamingHandler = new StreamingHandler('ai-adviser-output');}else{console.warn('StreamingHandler not available. Make sure streaming.js is loaded before ai_adviser.js');}}else{this.panel = document.getElementById('ai-panel');if (typeof StreamingHandler !== 'undefined'){this.streamingHandler = new StreamingHandler('ai-messages');}else{console.warn('StreamingHandler not available. Make sure streaming.js is loaded before ai_adviser.js');}}this.bindEvents();}createPanel(){const panelHTML = ` <div id="ai-panel" class="ai-panel"> <div class="ai-panel-header"> <div class="ai-panel-title">AI Adviser</div> <button class="ai-panel-close" id="ai-panel-close">‚úï</button> </div> <div class="ai-messages" id="ai-messages"></div> <div class="ai-input-area"> <div class="ai-input-wrapper"> <textarea id="ai-input" class="ai-input" placeholder="Ask RISKCAST AI anything..." rows="1" ></textarea> <button id="ai-send-button" class="ai-send-button">‚û§</button> </div> </div> </div> `;document.body.insertAdjacentHTML('beforeend', panelHTML);}bindEvents(){const toggleBtn = document.getElementById('ai-chat-toggle');if (toggleBtn){toggleBtn.addEventListener('click', () => this.openSidebar());}const oldToggleBtn = document.getElementById('ai-panel-toggle');if (oldToggleBtn){oldToggleBtn.addEventListener('click', () => this.toggle());}const closeBtn = document.getElementById('ai-chat-close');if (closeBtn){closeBtn.addEventListener('click', () => this.closeSidebar());}const oldCloseBtn = document.getElementById('ai-panel-close');if (oldCloseBtn){oldCloseBtn.addEventListener('click', () => this.close());}const sendBtn = document.getElementById('ai-chat-send');const input = document.getElementById('ai-chat-input');const oldSendBtn = document.getElementById('ai-send-button');const oldInput = document.getElementById('ai-input');const activeSendBtn = sendBtn || oldSendBtn;const activeInput = input || oldInput;if (activeSendBtn && activeInput){activeSendBtn.addEventListener('click', () => this.sendMessage());activeInput.addEventListener('keydown', (e) =>{if (e.key === 'Enter' && !e.shiftKey){e.preventDefault();this.sendMessage();}});activeInput.addEventListener('input', () =>{activeInput.style.height = 'auto';activeInput.style.height = Math.min(activeInput.scrollHeight, 120) + 'px';});}}closeSidebar(){if (this.sidebar){this.sidebar.classList.remove('active');}}openSidebar(){if (this.sidebar){this.sidebar.classList.add('active');}}toggle(){if (this.isOpen){this.close();}else{this.open();}}open(){if (this.panel){this.panel.classList.add('open');this.isOpen = true;const input = document.getElementById('ai-input');if (input){setTimeout(() => input.focus(), 300);}}}close(){if (this.panel){this.panel.classList.remove('open');this.isOpen = false;}}appendMessage(role, text){const output = document.getElementById('ai-adviser-output') || document.getElementById('ai-messages');if (!output) return;const box = document.createElement('div');box.className = `ai-message ${role}`;box.textContent = text;output.appendChild(box);output.scrollTop = output.scrollHeight;return box;}async sendMessage(){const input = document.getElementById('ai-chat-input') || document.getElementById('ai-input');const sendBtn = document.getElementById('ai-chat-send') || document.getElementById('ai-send-button');if (!input || !sendBtn) return;const message = input.value.trim();if (!message) return;input.value = '';input.style.height = 'auto';sendBtn.disabled = true;this.appendMessage('user', message);const loadingBox = this.appendMessage('ai', '...');loadingBox.innerHTML = '<div class="ai-loading"><div class="ai-loading-dot"></div><div class="ai-loading-dot"></div><div class="ai-loading-dot"></div></div>';try{this.currentStreamingMessage = this.appendMessage('ai', '');this.currentStreamingMessage.textContent = '';await this.streamFromAPI('/api/ai/stream',{prompt: message, context: this.getContext()});}catch (error){console.error('Error sending message:', error);if (this.currentStreamingMessage){this.currentStreamingMessage.textContent = 'Sorry, I encountered an error. Please try again.';}else{this.appendMessage('ai', 'Sorry, I encountered an error. Please try again.');}}finally{if (loadingBox && loadingBox.parentNode){loadingBox.remove();}sendBtn.disabled = false;this.currentStreamingMessage = null;}}async streamFromAPI(endpoint, payload){const response = await fetch(endpoint,{method: 'POST', headers:{'Content-Type': 'application/json',}, body: JSON.stringify(payload)});if (!response.ok){throw new Error(`HTTP error! status: ${response.status}`);}const reader = response.body.getReader();const decoder = new TextDecoder();const output = document.getElementById('ai-adviser-output') || document.getElementById('ai-messages');while (true){const{done, value}= await reader.read();if (done) break;const chunk = decoder.decode(value,{stream: true});const lines = chunk.split('\n');for (const line of lines){if (line.startsWith('data: ')){const data = line.slice(6);if (data === '[DONE]'){return;}try{const parsed = JSON.parse(data);if (parsed.text && this.currentStreamingMessage){this.currentStreamingMessage.textContent += parsed.text;if (output){output.scrollTop = output.scrollHeight;}}}catch (e){}}}}}getContext(){const context ={};const riskData = window.riskData ||{};if (Object.keys(riskData).length > 0){context.shipment_data = riskData;}return context;}async ask(question, context ={}){if (!this.isOpen){this.open();}await new Promise(resolve => setTimeout(resolve, 400));const input = document.getElementById('ai-input');if (input){input.value = question;this.sendMessage();}}async analyzeShipment(shipmentData){if (!this.isOpen){this.open();}this.streamingHandler.showLoading();try{const response = await fetch('/api/ai/analyze',{method: 'POST', headers:{'Content-Type': 'application/json',}, body: JSON.stringify({shipment_data: shipmentData})});const data = await response.json();if (data.status === 'success'){this.displayInsights(data);}else{throw new Error(data.message || 'Analysis failed');}}catch (error){console.error('Analysis error:', error);this.streamingHandler.appendText('Error analyzing shipment: ' + error.message);}finally{this.streamingHandler.hideLoading();}}displayInsights(data){const insights = data.insights ||{};const summary = data.summary || '';if (summary){this.streamingHandler.appendText(`**Executive Summary:**\n\n${summary}`);}if (insights.ai_analysis){this.streamingHandler.appendText(`**AI Analysis:**\n\n${insights.ai_analysis}`);}const metrics = ` **Key Metrics:** - Overall Risk: ${insights.overall_risk?.toFixed(1)}/100 (${insights.risk_level}) - Expected Loss: $${insights.expected_loss?.toFixed(2)}- Reliability: ${insights.reliability?.toFixed(1)}% `.trim();this.streamingHandler.appendText(metrics);}}let aiAdviser = null;document.addEventListener('DOMContentLoaded', () =>{aiAdviser = new AIAdviserPanel();window.aiAdviser = aiAdviser;});if (typeof module !== 'undefined' && module.exports){module.exports = AIAdviserPanel;}document.addEventListener('DOMContentLoaded', () =>{const botButton = document.getElementById('aiBotButton');const popup = document.getElementById('aiChatPopup');const closeBtn = document.getElementById('aiPopupClose');if (botButton && popup){botButton.onclick = () =>{popup.classList.remove('hidden');};}if (closeBtn && popup){closeBtn.onclick = () =>{popup.classList.add('hidden');};}});function appendPopupMessage(role, text){const messagesContainer = document.getElementById('aiPopupMessages');if (!messagesContainer) return;const box = document.createElement('div');box.className = 'ai-message ' + role;box.innerText = text;messagesContainer.appendChild(box);box.scrollIntoView({behavior: 'smooth', block: 'end'});return box;}async function sendPopupMessage(){const input = document.getElementById('aiPopupInput');const sendBtn = document.getElementById('aiPopupSend');if (!input || !sendBtn) return;const q = input.value.trim();if (!q) return;appendPopupMessage('user', q);input.value = '';const loadingMsg = appendPopupMessage('ai', 'ƒêang x·ª≠ l√Ω...');sendBtn.disabled = true;try{const res = await fetch('/api/ai/stream',{method: 'POST', headers:{'Content-Type': 'application/json'}, body: JSON.stringify({prompt: q})});if (!res.ok){throw new Error(`HTTP error! status: ${res.status}`);}loadingMsg.remove();const aiMsg = appendPopupMessage('ai', '');let full = '';const reader = res.body.getReader();const decoder = new TextDecoder();while (true){const{value, done}= await reader.read();if (done) break;const chunk = decoder.decode(value,{stream: true});const lines = chunk.split('\n');for (const line of lines){if (!line.trim()) continue;if (line.startsWith('data: ')){const data = line.slice(6);if (data === '[DONE]'){return;}try{const parsed = JSON.parse(data);if (parsed.text){full += parsed.text;aiMsg.innerText = full;aiMsg.scrollIntoView({behavior: 'smooth', block: 'end'});}}catch (e){full += data;aiMsg.innerText = full;aiMsg.scrollIntoView({behavior: 'smooth', block: 'end'});}}else{full += line;aiMsg.innerText = full;aiMsg.scrollIntoView({behavior: 'smooth', block: 'end'});}}}}catch (e){console.error('Popup chat error:', e);loadingMsg.remove();appendPopupMessage('ai', 'Xin l·ªói, ƒë√£ x·∫£y ra l·ªói. Vui l√≤ng th·ª≠ l·∫°i.');}finally{sendBtn.disabled = false;}}document.addEventListener('DOMContentLoaded', () =>{const sendBtn = document.getElementById('aiPopupSend');const input = document.getElementById('aiPopupInput');if (sendBtn){sendBtn.onclick = sendPopupMessage;}if (input){input.addEventListener('keydown', (e) =>{if (e.key === 'Enter' && !e.shiftKey){e.preventDefault();sendPopupMessage();}});}});document.addEventListener("DOMContentLoaded", function (){const monthInput = document.getElementById("shipment-month");const climateSection = document.getElementById("climate-section");if (!monthInput || !climateSection){console.log('‚ö†Ô∏è Climate data updater: monthInput or climateSection not found');return;}function updateClimateData(){const val = monthInput.value;if (!val) return;if (!window.CLIMATE_DATA_2025){console.warn('‚ö†Ô∏è CLIMATE_DATA_2025 not loaded yet, retrying...');setTimeout(updateClimateData, 100);return;}const monthIdx = parseInt(val.split("-")[1]) - 1;if (monthIdx < 0 || monthIdx > 11){console.warn('‚ö†Ô∏è Invalid month index:', monthIdx);return;}const data = window.CLIMATE_DATA_2025.climate_data_2025.months[monthIdx];if (!data){console.warn('‚ö†Ô∏è No climate data for month index:', monthIdx);return;}console.log('‚úÖ Climate data loaded from local JSON:', data);const ensoEl = document.getElementById("enso-value");if (ensoEl){const oniSign = data.oni >= 0 ? '+' : '';const ensoPhase = data.enso === 'La Ni√±a' ? 'La Ni√±a Phase' : data.enso === 'El Ni√±o' ? 'El Ni√±o Phase' : 'Neutral Phase';ensoEl.textContent = `${ensoPhase}(ONI: ${oniSign}${data.oni}¬∞C)`;}const stormEl = document.getElementById("storm-value");if (stormEl){stormEl.textContent = `${data.storms}c∆°n b√£o d·ª± ki·∫øn`;}const sstEl = document.getElementById("sst-value");if (sstEl){sstEl.textContent = `${data.sst > 0 ? "+" : ""}${data.sst}¬∞C`;}const stress = data.stress;const stressSlider = document.getElementById("climate-stress-slider");const stressValue = document.getElementById("climate-stress-value");const stressBadge = document.getElementById("climate-stress-badge");if (stressSlider){stressSlider.value = stress;stressSlider.disabled = true;stressSlider.style.opacity = '0.7';stressSlider.style.cursor = 'not-allowed';}if (stressValue){stressValue.textContent = stress.toFixed(1);}if (stressBadge){stressBadge.className = stress >= 8 ? "badge critical" : stress >= 6 ? "badge warning" : "badge good";stressBadge.textContent = stress >= 8 ? "Critical" : stress >= 6 ? "Cao" : "Th·∫•p";}const portClimateStress = document.getElementById("port_climate_stress");if (portClimateStress){const portStress = Math.min(10, stress * 0.8);portClimateStress.value = portStress.toFixed(1);portClimateStress.disabled = true;portClimateStress.style.opacity = '0.7';portClimateStress.style.cursor = 'not-allowed';const portStressDisplay = document.getElementById("port_climate_stress_display");if (portStressDisplay){portStressDisplay.textContent = `${portStress.toFixed(1)}/10`;}}const climateVolatility = document.getElementById("climate_volatility_index");if (climateVolatility){const volatility = Math.min(100, stress * 10);climateVolatility.value = Math.round(volatility);climateVolatility.disabled = true;climateVolatility.style.opacity = '0.7';climateVolatility.style.cursor = 'not-allowed';const volatilityDisplay = document.getElementById("climate_volatility_index_display");if (volatilityDisplay){volatilityDisplay.textContent = `${Math.round(volatility)}/100`;}}const climateResilience = document.getElementById("climate_resilience");if (climateResilience){const resilience = Math.max(1, 10 - stress * 0.8);climateResilience.value = resilience.toFixed(1);climateResilience.disabled = true;climateResilience.style.opacity = '0.7';climateResilience.style.cursor = 'not-allowed';const resilienceDisplay = document.getElementById("climate_resilience_display");if (resilienceDisplay){resilienceDisplay.textContent = `${resilience.toFixed(1)}/10`;}}updateClimatePreviewCard(data);}function updateClimatePreviewCard(data){const previewCard = document.getElementById("climate-preview");const climateSection = document.getElementById("climate-section");if (!previewCard) return;const stress = data.stress;const ensoStatus = data.enso;const storms = data.storms;const oni = data.oni;const sst = data.sst;const monthNames = ['Th√°ng M·ªôt', 'Th√°ng Hai', 'Th√°ng Ba', 'Th√°ng T∆∞', 'Th√°ng NƒÉm', 'Th√°ng S√°u', 'Th√°ng B·∫£y', 'Th√°ng T√°m', 'Th√°ng Ch√≠n', 'Th√°ng M∆∞·ªùi', 'Th√°ng M∆∞·ªùi M·ªôt', 'Th√°ng M∆∞·ªùi Hai'];const monthIdx = parseInt(document.getElementById('shipment-month')?.value?.split('-')[1]) - 1;const monthName = monthIdx >= 0 ? monthNames[monthIdx] : '';const monthNumber = monthIdx + 1;const riskIncrease = ensoStatus === 'La Ni√±a' && stress >= 8 ? Math.round((stress - 5) * 8) : 0;const delayRecommendation = stress >= 8 && storms >= 3 ? '3‚Äì5 ng√†y' : stress >= 8 ? '2‚Äì3 ng√†y' : '';let statusText = '';let statusIcon = 'üåä';let badgeStyle = '';const oniSign = oni >= 0 ? '+' : '';if (ensoStatus === 'La Ni√±a'){const intensity = Math.abs(oni) >= 1.0 ? 'Strong' : Math.abs(oni) >= 0.5 ? 'Moderate' : 'Weak';statusIcon = 'üåä';statusText = `${intensity}La Ni√±a Phase (ONI: ${oniSign}${oni}¬∞C)`;badgeStyle = stress >= 8 ? 'background: linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(220, 38, 38, 0.4));border-color: rgba(239, 68, 68, 0.6);' : 'background: linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(245, 158, 11, 0.4));border-color: rgba(251, 191, 36, 0.6);';}else if (ensoStatus === 'El Ni√±o'){const intensity = Math.abs(oni) >= 1.0 ? 'Strong' : Math.abs(oni) >= 0.5 ? 'Moderate' : 'Weak';statusIcon = 'üî•';statusText = `${intensity}El Ni√±o Phase (ONI: ${oniSign}${oni}¬∞C)`;badgeStyle = 'background: linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(220, 38, 38, 0.4));border-color: rgba(239, 68, 68, 0.6);';}else{statusIcon = '‚úÖ';statusText = `Neutral Phase (ONI: ${oniSign}${oni}¬∞C)`;badgeStyle = 'background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(5, 150, 105, 0.4));border-color: rgba(16, 185, 129, 0.6);';}const stressClass = stress >= 8 ? 'critical' : stress >= 6 ? 'warning' : 'good';const stressText = stress >= 8 ? 'Critical' : stress >= 6 ? 'Cao' : 'Th·∫•p';const stressColor = stressClass === 'critical' ? '#EF4444' : stressClass === 'warning' ? '#FBBF24' : '#10B981';let carrierRecommendation = '';if (stress >= 8){const routeValue = document.getElementById('route_input')?.value || '';if (routeValue && window.LOGISTICS_DATA){const carriers = window.LOGISTICS_DATA.getCarriersByRoute(routeValue);if (carriers && carriers.length > 0){const bestCarrier = carriers.reduce((prev, curr) => (curr.rating > prev.rating) ? curr : prev );carrierRecommendation = `Ch·ªçn ${bestCarrier.name}(${bestCarrier.rating.toFixed(1)}‚≠ê, on-time ${bestCarrier.ontime}%)`;}else{carrierRecommendation = 'Ch·ªçn h√£ng t√†u c√≥ ESG cao (Maersk, MSC)';}}else{carrierRecommendation = 'Ch·ªçn h√£ng t√†u c√≥ ESG cao (Maersk, MSC)';}}const monthMessages ={1: 'Th√°ng n√†y th∆∞·ªùng c√≥ m∆∞a l·ªõn v√† gi√≥ m·∫°nh ·ªü khu v·ª±c ƒê√¥ng Nam √Å', 2: 'Th·ªùi ti·∫øt ·ªïn ƒë·ªãnh h∆°n, nh∆∞ng v·∫´n c·∫ßn theo d√µi ENSO', 3: 'B·∫Øt ƒë·∫ßu m√πa m∆∞a, r·ªßi ro b√£o tƒÉng d·∫ßn', 4: 'M√πa m∆∞a ch√≠nh, r·ªßi ro cao nh·∫•t trong nƒÉm', 5: 'M√πa m∆∞a ti·∫øp t·ª•c, c·∫ßn c·∫©n th·∫≠n v·ªõi b√£o', 6: 'Chuy·ªÉn giao m√πa, th·ªùi ti·∫øt bi·∫øn ƒë·ªông', 7: 'M√πa kh√¥ b·∫Øt ƒë·∫ßu, r·ªßi ro th·∫•p h∆°n', 8: 'M√πa kh√¥, ƒëi·ªÅu ki·ªán t·ªët cho v·∫≠n chuy·ªÉn', 9: 'Th·ªùi ti·∫øt ·ªïn ƒë·ªãnh, r·ªßi ro th·∫•p', 10: 'B·∫Øt ƒë·∫ßu m√πa m∆∞a, c·∫ßn theo d√µi', 11: 'M√πa m∆∞a, r·ªßi ro b√£o cao', 12: 'Cu·ªëi nƒÉm, th·ªùi ti·∫øt bi·∫øn ƒë·ªông'};const monthSpecificMessage = monthMessages[monthNumber] || '';const warningList = [];if (ensoStatus === 'La Ni√±a' && stress >= 8){const oniSign = oni >= 0 ? '+' : '';warningList.push(`Strong La Ni√±a Phase (ONI: ${oniSign}${oni}¬∞C) ‚Üí ${riskIncrease > 0 ? `+${riskIncrease}%` : 'tƒÉng'}r·ªßi ro b√£o`);}if (storms > 0){warningList.push(`${storms}b√£o d·ª± ki·∫øn trong ${monthName}`);}if (delayRecommendation){warningList.push(`<strong>Khuy√™n delay ${delayRecommendation}</strong>`);}if (carrierRecommendation){warningList.push(carrierRecommendation);}if (monthSpecificMessage){warningList.push(monthSpecificMessage);}const statusBadge = previewCard.querySelector('#climate-status-badge');const statusTextEl = previewCard.querySelector('#climate-status-text');const stressDisplay = previewCard.querySelector('#climate-stress-display');const stressBadgeDisplay = previewCard.querySelector('#climate-stress-badge-display');const recText = previewCard.querySelector('#climate-rec-text');const warningListEl = previewCard.querySelector('#climate-warning-list');const warningSection = previewCard.querySelector('#climate-warning-section');if (statusBadge){statusBadge.style.cssText = badgeStyle;}if (statusTextEl){statusTextEl.innerHTML = `<span class="status-icon">${statusIcon}</span> ${statusText}`;}if (stressDisplay){stressDisplay.textContent = `${stress.toFixed(1)}/10`;stressDisplay.style.color = stressColor;}if (stressBadgeDisplay){stressBadgeDisplay.textContent = stressText;stressBadgeDisplay.className = `badge ${stressClass}`;}if (recText){recText.textContent = carrierRecommendation || 'ƒêi·ªÅu ki·ªán kh√≠ h·∫≠u ·ªïn ƒë·ªãnh';}if (warningListEl){warningListEl.innerHTML = warningList.map(item => `<li>${item}</li>`).join('');}if (warningSection){warningSection.style.display = warningList.length > 0 ? 'block' : 'none';}previewCard.style.display = 'block';if (climateSection){climateSection.style.display = 'block';}}function lockClimateSliders(){const sliders = [{id: 'climate-stress-slider', style: 'opacity: 0.7;cursor: not-allowed;'},{id: 'port_climate_stress', style: 'opacity: 0.7;cursor: not-allowed;background: rgba(0,255,136,0.05);'},{id: 'climate_volatility_index', style: 'opacity: 0.7;cursor: not-allowed;background: rgba(0,255,136,0.05);'},{id: 'climate_resilience', style: 'opacity: 0.7;cursor: not-allowed;'}];sliders.forEach(slider =>{const el = document.getElementById(slider.id);if (el){el.disabled = true;el.setAttribute('readonly', 'readonly');if (slider.style){el.style.cssText += slider.style;}}});}lockClimateSliders();monthInput.addEventListener('change', () =>{updateClimateData();lockClimateSliders();});monthInput.addEventListener('input', () =>{updateClimateData();lockClimateSliders();});if (monthInput.value){updateClimateData();if (!window.CLIMATE_DATA_2025){const checkInterval = setInterval(() =>{if (window.CLIMATE_DATA_2025){clearInterval(checkInterval);updateClimateData();lockClimateSliders();}}, 100);setTimeout(() => clearInterval(checkInterval), 2000);}}});(function(){'use strict';const sections = [{id: 'shipping-info', name: 'Transport Setup', fields: ['route', 'transport_mode', 'pol', 'pod', 'distance', 'transit_time', 'carrier', 'cargo_type', 'container', 'incoterm', 'packaging', 'priority']},{id: 'cargo-details', name: 'Cargo & Packing', fields: ['etd', 'eta', 'cargo_value', 'packages']},{id: 'seller-info', name: 'Seller Information', fields: ['seller_name', 'seller_country', 'seller_email', 'seller_phone', 'seller_address', 'seller_pic']},{id: 'buyer-info', name: 'Buyer Information', fields: ['buyer_name', 'buyer_country', 'buyer_email', 'buyer_phone', 'buyer_address', 'buyer_pic']},{id: 'algorithm-modules', name: 'Algorithm Modules', fields: ['use_fuzzy', 'use_forecast', 'use_mc', 'use_var']},{id: 'summaryOverviewSection', name: 'Summary Overview', fields: []}];function initEnterpriseInput(){console.log('‚úì Enterprise Input Layout initialized');setupSidebarNavigation();setupIntersectionObserver();setupCompletionTracking();wrapSectionsInCards();updateCompletionStatus();}function setupSidebarNavigation(){const navItems = document.querySelectorAll('.sidebar-nav-item');navItems.forEach(item =>{item.addEventListener('click', function(e){e.preventDefault();const sectionId = this.getAttribute('data-section');const section = document.getElementById(sectionId);if (section){section.scrollIntoView({behavior: 'smooth', block: 'start'});navItems.forEach(nav => nav.classList.remove('active'));this.classList.add('active');}});});}function setupIntersectionObserver(){const observerOptions ={root: null, rootMargin: '-20% 0px -60% 0px', threshold: 0};const observer = new IntersectionObserver((entries) =>{entries.forEach(entry =>{const sectionId = entry.target.id;const navItem = document.querySelector(`.sidebar-nav-item[data-section="${sectionId}"]`);const sectionCard = entry.target.closest('.enterprise-section-card');if (entry.isIntersecting){document.querySelectorAll('.sidebar-nav-item').forEach(item =>{item.classList.remove('active');});if (navItem) navItem.classList.add('active');if (sectionCard){document.querySelectorAll('.enterprise-section-card').forEach(card =>{card.classList.remove('active');});sectionCard.classList.add('active');}}});}, observerOptions);sections.forEach(section =>{const element = document.getElementById(section.id);if (element){observer.observe(element);}});}function wrapSectionsInCards(){sections.forEach(section =>{const sectionEl = document.getElementById(section.id);if (!sectionEl) return;if (sectionEl.classList.contains('already-wrapped')) return;const card = document.createElement('div');card.className = 'enterprise-section-card';const header = document.createElement('div');header.className = 'section-card-header';const titleEl = sectionEl.querySelector('.section-header h2');const subtitleEl = sectionEl.querySelector('.section-header p');if (titleEl){header.innerHTML = ` <div class="section-card-title">${titleEl.textContent}</div> ${subtitleEl ? `<div class="section-card-subtitle">${subtitleEl.textContent}</div>` : ''}`;}const sectionContent = sectionEl.querySelector('.form-grid, .form-group, .packing-list-section');if (sectionContent || sectionEl.children.length > 1){card.appendChild(header);const childrenToMove = Array.from(sectionEl.children).filter(child => !child.classList.contains('section-header'));childrenToMove.forEach(child =>{card.appendChild(child);});sectionEl.innerHTML = '';sectionEl.appendChild(card);sectionEl.classList.add('already-wrapped');}});}function calculateSectionCompletion(sectionId){const section = sections.find(s => s.id === sectionId);if (!section) return 0;let filledCount = 0;const totalFields = section.fields.length;section.fields.forEach(fieldName =>{let field = null;field = document.getElementById(fieldName) || document.getElementById(`${fieldName}_input`) || document.getElementById(`${fieldName}_dropdown`) || document.querySelector(`[name="${fieldName}"]`);if (field){let value = '';if (field.type === 'checkbox'){value = field.checked ? 'checked' : '';}else if (field.tagName === 'SELECT'){value = field.value;}else if (field.classList && field.classList.contains('custom-dropdown')){const dropdownValue = field.querySelector('.dropdown-value');value = dropdownValue && !dropdownValue.classList.contains('placeholder') ? dropdownValue.textContent : '';}else{value = field.value || field.textContent;}if (value && value.trim() !== '' && value !== 'Ch·ªçn' && value !== 'Select'){filledCount++;}}});return Math.round((filledCount / totalFields) * 100);}function updateCompletionStatus(){sections.forEach(section =>{const percent = calculateSectionCompletion(section.id);const navItem = document.querySelector(`.sidebar-nav-item[data-section="${section.id}"]`);if (navItem){if (percent === 100){navItem.classList.add('completed');}else{navItem.classList.remove('completed');}}const aiItem = document.querySelector(`.ai-section-item[data-section="${section.id}"]`);if (aiItem){const percentEl = aiItem.querySelector('.ai-section-percent');const progressFill = aiItem.querySelector('.ai-progress-fill');const badge = aiItem.querySelector('.completion-badge');if (percentEl) percentEl.textContent = `${percent}%`;if (progressFill) progressFill.style.width = `${percent}%`;if (percent === 100){aiItem.classList.add('completed');if (badge) badge.style.display = 'inline-flex';}else{aiItem.classList.remove('completed');if (badge) badge.style.display = 'none';}}});}function setupCompletionTracking(){const form = document.getElementById('risk_form');if (!form) return;let updateTimeout;function debouncedUpdate(){clearTimeout(updateTimeout);updateTimeout = setTimeout(updateCompletionStatus, 200);}form.addEventListener('input', debouncedUpdate);form.addEventListener('change', debouncedUpdate);form.addEventListener('click', function(e){if (e.target.type === 'checkbox' || e.target.classList.contains('dropdown-option')){debouncedUpdate();}});document.addEventListener('dropdownChange', debouncedUpdate);}if (document.readyState === 'loading'){document.addEventListener('DOMContentLoaded', initEnterpriseInput);}else{initEnterpriseInput();}setTimeout(initEnterpriseInput, 1000);function setupAlgorithmToggles(){document.querySelectorAll('.algorithm-module-card').forEach(card =>{const checkbox = card.querySelector('input[type="checkbox"]');const toggleSwitch = card.querySelector('.toggle-switch-enterprise');if (checkbox && toggleSwitch){if (checkbox.checked){toggleSwitch.classList.add('active');card.classList.add('active');}toggleSwitch.addEventListener('click', function(e){e.preventDefault();checkbox.checked = !checkbox.checked;if (checkbox.checked){toggleSwitch.classList.add('active');card.classList.add('active');}else{toggleSwitch.classList.remove('active');card.classList.remove('active');}checkbox.dispatchEvent(new Event('change',{bubbles: true}));});checkbox.addEventListener('change', function(){if (this.checked){toggleSwitch.classList.add('active');card.classList.add('active');}else{toggleSwitch.classList.remove('active');card.classList.remove('active');}});}});}setTimeout(setupAlgorithmToggles, 1500);function setupClimatePanel(){const monthInput = document.getElementById('shipment-month');const climatePanel = document.getElementById('climate-risk-panel');if (monthInput && climatePanel){monthInput.addEventListener('change', function(){if (this.value){climatePanel.style.display = 'block';}});}const monthDisplay = document.getElementById('shipment-month-display');if (monthDisplay){monthDisplay.addEventListener('click', function(){setTimeout(() =>{const monthInput = document.getElementById('shipment-month');if (monthInput && monthInput.value && climatePanel){climatePanel.style.display = 'block';}}, 100);});}}setTimeout(setupClimatePanel, 1500);})();function toggleClimate(){const panel = document.getElementById('climate-panel');if (panel){panel.classList.toggle('expanded');const body = panel.querySelector('#climate-body');const arrow = panel.querySelector('#climate-arrow');if (body){body.classList.toggle('hidden');if (body.classList.contains('hidden')){body.style.maxHeight = '0';}else{body.style.maxHeight = body.scrollHeight + 'px';}}if (arrow){}}}function toggleClimatePanel(){toggleClimate();}window.toggleClimate = toggleClimate;window.toggleClimatePanel = toggleClimatePanel;function toggleLeftSidebar(){const sidebar = document.querySelector('.enterprise-sidebar');if (sidebar){sidebar.classList.toggle('collapsed');localStorage.setItem('leftSidebarCollapsed', sidebar.classList.contains('collapsed'));}}function toggleRightSidebar(){toggleAIPanel();}let isAIPanelTransitioning = false;function toggleAIPanel(){if (isAIPanelTransitioning){return;}const panel = document.getElementById('aiSmartPanel');const body = document.body;if (!panel){console.warn('AI Smart Panel not found');return;}isAIPanelTransitioning = true;const isCurrentlyHidden = body.classList.contains('body--ai-panel-hidden');if (isCurrentlyHidden){body.classList.remove('body--ai-panel-hidden');panel.classList.remove('collapsed');}else{body.classList.add('body--ai-panel-hidden');panel.classList.add('collapsed');}localStorage.setItem('aiPanelHidden', !isCurrentlyHidden);setTimeout(() =>{isAIPanelTransitioning = false;}, 600);}document.addEventListener('DOMContentLoaded', function(){const leftCollapsed = localStorage.getItem('leftSidebarCollapsed') === 'true';const leftSidebar = document.querySelector('.enterprise-sidebar');if (leftSidebar && leftCollapsed){leftSidebar.classList.add('collapsed');}const rightCollapsed = localStorage.getItem('rightSidebarCollapsed') === 'true';const rightSidebar = document.querySelector('.enterprise-ai-panel');if (rightSidebar && rightCollapsed){rightSidebar.classList.add('collapsed');}const aiPanelHidden = localStorage.getItem('aiPanelHidden') === 'true';const aiPanel = document.getElementById('aiSmartPanel');if (aiPanel && aiPanelHidden){document.body.classList.add('body--ai-panel-hidden');aiPanel.classList.add('collapsed');}});window.toggleLeftSidebar = toggleLeftSidebar;window.toggleRightSidebar = toggleRightSidebar;window.toggleAIPanel = toggleAIPanel;const RatingInterpreter ={getReliabilityRating: function(value){const num = parseInt(value);if (num >= 86){return{label: 'Excellent', icon: '‚úì‚úì', class: 'excellent', color: '#10b981', bg: 'linear-gradient(135deg, #10b981, #059669)'};}else if (num >= 61){return{label: 'Good', icon: '‚úì', class: 'good', color: '#3b82f6', bg: 'linear-gradient(135deg, #3b82f6, #2563eb)'};}else if (num >= 31){return{label: 'Fair', icon: '‚ö†Ô∏è', class: 'fair', color: '#fbbf24', bg: 'linear-gradient(135deg, #fbbf24, #f59e0b)'};}else{return{label: 'Unreliable', icon: '‚ùå', class: 'poor', color: '#ef4444', bg: 'linear-gradient(135deg, #ef4444, #dc2626)'};}}, getCarrierRating: function(value){const num = parseFloat(value);if (num >= 4.6){return{label: 'Outstanding', icon: '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê', class: 'excellent', color: '#10b981'};}else if (num >= 3.6){return{label: 'Good', icon: '‚≠ê‚≠ê‚≠ê', class: 'good', color: '#3b82f6'};}else if (num >= 2.1){return{label: 'Average', icon: '‚≠ê‚≠ê', class: 'fair', color: '#fbbf24'};}else{return{label: 'Poor', icon: '‚≠ê', class: 'poor', color: '#ef4444'};}}, getRiskRating: function(value){const num = parseFloat(value);if (num >= 8.1){return{label: 'Extreme Risk', icon: 'üå™Ô∏è', class: 'extreme', color: '#dc2626', suggestion: 'Delay Recommended'};}else if (num >= 6.1){return{label: 'High Risk', icon: '‚õàÔ∏è', class: 'high', color: '#ef4444', suggestion: 'Monitor Closely'};}else if (num >= 3.1){return{label: 'Moderate Risk', icon: 'üå§Ô∏è', class: 'moderate', color: '#fbbf24', suggestion: 'Normal Conditions'};}else{return{label: 'Low Risk', icon: '‚òÄÔ∏è', class: 'low', color: '#10b981', suggestion: 'Favorable'};}}, getContainerMatchRating: function(value){const num = parseFloat(value);if (num >= 8.5){return{label: 'Optimal', icon: '‚úì‚úì', class: 'excellent', color: '#10b981'};}else if (num >= 6.0){return{label: 'Good', icon: '‚úì', class: 'good', color: '#3b82f6'};}else if (num >= 4.0){return{label: 'Fair', icon: '‚ö†Ô∏è', class: 'fair', color: '#fbbf24'};}else{return{label: 'Poor', icon: '‚ùå', class: 'poor', color: '#ef4444'};}}, getPriorityRating: function(value){const num = parseInt(value);if (num >= 8){return{label: 'Highest', icon: 'üî¥', class: 'highest', color: '#ef4444'};}else if (num >= 5){return{label: 'High', icon: 'üü°', class: 'high', color: '#fbbf24'};}else{return{label: 'Low', icon: 'üü¢', class: 'low', color: '#10b981'};}}};(function injectPriorityWeightsHelpers(){if (window.__priorityWeightsInjected){return;}const PRIORITY_WEIGHT_MAPPING ={economy:{speed: 20, cost: 60, risk: 20, description: '∆Øu ti√™n chi ph√≠ th·∫•p, ch·∫•p nh·∫≠n th·ªùi gian l√¢u h∆°n'}, standard:{speed: 40, cost: 40, risk: 20, description: 'C√¢n b·∫±ng gi·ªØa chi ph√≠, th·ªùi gian v√† r·ªßi ro'}, express:{speed: 70, cost: 20, risk: 10, description: '∆Øu ti√™n t·ªëc ƒë·ªô, ch·∫•p nh·∫≠n chi ph√≠ cao h∆°n'}, critical:{speed: 80, cost: 10, risk: 10, description: 'Giao h√†ng c·∫•p b√°ch, t·ªëi thi·ªÉu h√≥a r·ªßi ro tr·ªÖ'}};function getPriorityWeights(profile){return PRIORITY_WEIGHT_MAPPING[profile] || PRIORITY_WEIGHT_MAPPING.standard;}function updatePriorityWeightsDisplay(){const profileInput = document.getElementById('priority_input');const profile = profileInput?.value || 'standard';const weights = getPriorityWeights(profile);const speedDisplay = document.getElementById('priority_speed_display');const costDisplay = document.getElementById('priority_cost_display');const riskDisplay = document.getElementById('priority_risk_display');const descDisplay = document.getElementById('priority_description');if (speedDisplay) speedDisplay.textContent = `${weights.speed}%`;if (costDisplay) costDisplay.textContent = `${weights.cost}%`;if (riskDisplay) riskDisplay.textContent = `${weights.risk}%`;if (descDisplay) descDisplay.textContent = weights.description;}if (typeof window.getPriorityWeights !== 'function'){window.getPriorityWeights = getPriorityWeights;}if (typeof window.updatePriorityWeightsDisplay !== 'function'){window.updatePriorityWeightsDisplay = updatePriorityWeightsDisplay;}document.addEventListener('DOMContentLoaded', () =>{const priorityDropdown = document.getElementById('priority_dropdown');if (priorityDropdown){priorityDropdown.addEventListener('change', () =>{if (typeof window.updatePriorityWeightsDisplay === 'function'){window.updatePriorityWeightsDisplay();}});setTimeout(() =>{if (typeof window.updatePriorityWeightsDisplay === 'function'){window.updatePriorityWeightsDisplay();}}, 500);}});window.__priorityWeightsInjected = true;})();const BenchmarkData ={reliability:{industryAvg: 65, excellent: 85, poor: 30}, carrierRating:{industryAvg: 3.5, excellent: 4.5, poor: 2.0}, esgScore:{industryAvg: 65, excellent: 80, poor: 40}, containerMatch:{isoStandard: 8.0, optimal: 9.0, minimum: 6.0}, portClimateStress:{noaaAlert: 7.0, critical: 8.5, safe: 4.0}, climateVolatility:{stable: 30, moderate: 50, high: 70}};const SmartInputState ={selectedRoute: null, selectedTransportMode: null, selectedPOL: null, selectedPOD: null, selectedCargoType: null, recentShipments: [], validationErrors:{}, getLogisticsData: function(){return window._LOGISTICS_DATA_REF || window.LOGISTICS_DATA || (typeof LOGISTICS_DATA !== 'undefined' ? LOGISTICS_DATA : null);}, completedFields: new Set(), initialized: false};const SmartInputSystem ={getLogisticsData: function(){return SmartInputState.getLogisticsData ? SmartInputState.getLogisticsData() : (window.LOGISTICS_DATA || window._LOGISTICS_DATA_REF || (typeof LOGISTICS_DATA !== 'undefined' ? LOGISTICS_DATA : null));}, init: function(){if (window.__SMART_INPUT_INITIALIZED__ && SmartInputState.initialized){console.warn('[SmartInput] Already initialized, skipping auto-init...');return;}if (SmartInputState.initialized){console.log('‚ö†Ô∏è Smart Input System already initialized');return;}console.log('üöÄ Initializing Smart Input System v13.0 ULTIMATE...');if (typeof LOGISTICS_DATA === 'undefined' && typeof window.LOGISTICS_DATA === 'undefined'){console.error('‚ùå LOGISTICS_DATA not loaded! Please load logistics_data.js first.');console.warn('‚ö†Ô∏è Retrying in 500ms...');setTimeout(() =>{if (typeof LOGISTICS_DATA !== 'undefined' || typeof window.LOGISTICS_DATA !== 'undefined'){console.log('‚úÖ LOGISTICS_DATA loaded, re-initializing...');this.init();}else{console.error('‚ùå LOGISTICS_DATA still not available after retry');}}, 500);return;}const LOGISTICS_DATA_SOURCE = window.LOGISTICS_DATA || (typeof LOGISTICS_DATA !== 'undefined' ? LOGISTICS_DATA : null);if (!LOGISTICS_DATA_SOURCE){console.error('‚ùå LOGISTICS_DATA not available!');return;}window._LOGISTICS_DATA_REF = LOGISTICS_DATA_SOURCE;this.initRouteBasedSuggestions();this.initCountryAutoSuggest();this.initPortSelectors();this.initContainerRecommendation();this.initTransitTimeCalculation();this.initClimateAutoFetch();this.initRealtimeValidation();this.initProgressTracking();this.initSliderDisplays();this.initStarRating();this.initCollapsibleSections();this.initTooltips();this.initPresetButtons();this.initSectionEnhancements();this.initProgressRings();this.initSparklines();this.initPresetExportImport();this.initKeyboardShortcuts();this.initSmartDefaults();this.initConditionalFields();this.initCopyPreviousShipment();this.initMobileOptimization();this.initEnhancedDemoMode();SmartInputState.initialized = true;console.log('‚úÖ Smart Input System initialized successfully');}, initRouteBasedSuggestions: function(){console.log('‚úì [INIT] Route-Based Suggestions activated');const routeDropdown = document.getElementById('route_dropdown');if (!routeDropdown){console.warn('‚ö†Ô∏è Route dropdown not found');return;}const routeOptions = routeDropdown.querySelectorAll('.dropdown-option');routeOptions.forEach(option =>{option.addEventListener('click', (e) =>{e.stopPropagation();const routeKey = option.getAttribute('data-value');if (routeKey){console.log('üìç Route option clicked:', routeKey);setTimeout(() =>{this.handleRouteSelection(routeKey);}, 200);}});});setTimeout(() =>{const selectedRoute = this.getDropdownValue('route_dropdown');if (selectedRoute){console.log('üìç Found pre-selected route:', selectedRoute);this.handleRouteSelection(selectedRoute);}}, 500);const observer = new MutationObserver(() =>{const selectedOption = routeDropdown.querySelector('.dropdown-option.selected');if (selectedOption){const routeKey = selectedOption.getAttribute('data-value');if (routeKey && routeKey !== SmartInputState.selectedRoute){console.log('üìç Route changed via mutation:', routeKey);this.handleRouteSelection(routeKey);}}});observer.observe(routeDropdown,{childList: true, subtree: true, attributes: true, attributeFilter: ['class']});}, handleRouteSelection: function(routeKey){if (!routeKey){const routeValue = this.getDropdownValue('route_dropdown');if (!routeValue) return;routeKey = routeValue;}console.log(`üìç Route selected: ${routeKey}`);SmartInputState.selectedRoute = routeKey;try{this.populateTransportModes(routeKey);}catch (error){console.error('‚ùå Error in populateTransportModes:', error);console.error('Stack:', error.stack);}this.resetTransportDependentFields();}, populateTransportModes: function(routeKey){const LOGISTICS_DATA = SmartInputState.getLogisticsData ? SmartInputState.getLogisticsData() : (window.LOGISTICS_DATA || window._LOGISTICS_DATA_REF || (typeof LOGISTICS_DATA !== 'undefined' ? LOGISTICS_DATA : null));if (!LOGISTICS_DATA){console.error('‚ùå LOGISTICS_DATA not available in populateTransportModes');console.warn('‚ö†Ô∏è Retrying in 500ms...');setTimeout(() => this.populateTransportModes(routeKey), 500);return;}const logisticsRouteKey = LOGISTICS_DATA.mapRouteFromHTML ? LOGISTICS_DATA.mapRouteFromHTML(routeKey) : routeKey;console.log(`üìç populateTransportModes: HTML key="${routeKey}", logistics key="${logisticsRouteKey}"`);const route = LOGISTICS_DATA.getRoute(logisticsRouteKey);if (!route){console.error(`‚ùå Route "${logisticsRouteKey}" not found in LOGISTICS_DATA`);console.log('Available routes:', Object.keys(LOGISTICS_DATA.routes ||{}));return;}const transportModes = route.transport_modes;if (!transportModes || transportModes.length === 0){console.warn('‚ö†Ô∏è No transport modes for route:', routeKey);return;}console.log(`‚úì Found ${transportModes.length}transport modes for ${routeKey}`);const transportDropdown = document.getElementById('transport_mode_dropdown');const transportMenu = document.getElementById('transport_mode_menu') || transportDropdown?.querySelector('.dropdown-menu');const transportTrigger = transportDropdown?.querySelector('.dropdown-trigger .dropdown-value');if (!transportMenu){console.error('‚ùå Transport mode menu not found');console.log('Debug info:',{transportDropdown: !!transportDropdown, transportMenuById: !!document.getElementById('transport_mode_menu'), transportMenuByQuery: !!transportDropdown?.querySelector('.dropdown-menu'), dropdownHTML: transportDropdown ? transportDropdown.outerHTML.substring(0, 200) : 'null'});return;}console.log(`‚úì Transport menu found, populating ${transportModes.length}options...`);transportMenu.innerHTML = '';transportModes.sort((a, b) =>{if (a.default && !b.default) return -1;if (!a.default && b.default) return 1;return (b.share || 0) - (a.share || 0);});transportModes.forEach(mode =>{const option = document.createElement('div');option.className = 'dropdown-option';if (mode.default){option.classList.add('recommended');}option.setAttribute('data-value', mode.value);option.setAttribute('role', 'option');let optionText = mode.label;if (mode.default) optionText += ' [ƒê·ªÄ XU·∫§T]';if (mode.hours){optionText += ` ‚Ä¢ ${mode.hours}gi·ªù`;}else if (mode.days){optionText += ` ‚Ä¢ ${mode.days}ng√†y`;}if (mode.share){optionText += ` ‚Ä¢ ${mode.share}% th·ªã ph·∫ßn`;}const riskLabel = LOGISTICS_DATA.getRiskLabel(mode.risk_level);optionText += ` [R·ª¶I RO: ${riskLabel.toUpperCase()}]`;option.innerHTML = ` <div class="transport-option-content"> <div class="transport-label"> ${optionText}</div> <div class="transport-description">${mode.description || ''}</div> </div> `;option.addEventListener('click', (e) =>{e.stopPropagation();e.preventDefault();e.stopImmediatePropagation();console.log(`‚úì Transport mode clicked: ${mode.value}`);transportMenu.querySelectorAll('.dropdown-option').forEach(opt =>{opt.classList.remove('selected');});option.classList.add('selected');if (transportTrigger){transportTrigger.textContent = mode.label || mode.value;transportTrigger.classList.remove('placeholder');}const fullMode = route.transport_modes.find(m => m.value === mode.value);this.selectTransportMode(fullMode || mode, routeKey);if (transportDropdown){transportDropdown.classList.remove('active');}});transportMenu.appendChild(option);});console.log(`‚úÖ Successfully populated ${transportModes.length}transport mode options into menu`);console.log(` Menu now has ${transportMenu.children.length}children`);if (transportDropdown){const menu = transportDropdown.querySelector('.dropdown-menu') || transportMenu;if (menu){menu.style.setProperty('display', 'block', 'important');menu.style.setProperty('visibility', 'visible', 'important');menu.style.setProperty('opacity', '1', 'important');menu.style.setProperty('z-index', '10003', 'important');}}if (transportDropdown){const trigger = transportDropdown.querySelector('.dropdown-trigger');if (trigger){document.querySelectorAll('.custom-dropdown.active').forEach(dd =>{if (dd !== transportDropdown){dd.classList.remove('active');const menu = dd.querySelector('.dropdown-menu');if (menu){menu.style.display = 'none';menu.style.visibility = 'hidden';menu.style.opacity = '0';}}});const newTrigger = trigger.cloneNode(true);trigger.parentNode.replaceChild(newTrigger, trigger);newTrigger.addEventListener('click', (e) =>{e.stopPropagation();e.preventDefault();if (typeof closeAllDropdowns === 'function'){closeAllDropdowns(transportDropdown.id);}else{document.querySelectorAll('.custom-dropdown.active').forEach(dd =>{if (dd !== transportDropdown){dd.classList.remove('active');const menu = dd.querySelector('.dropdown-menu');if (menu){menu.style.display = 'none';menu.style.visibility = 'hidden';menu.style.opacity = '0';menu.classList.remove('active');}}});}const isActive = transportDropdown.classList.contains('active');if (isActive){transportDropdown.classList.remove('active');const menu = transportDropdown.querySelector('.dropdown-menu');if (menu){menu.style.display = 'none';menu.style.visibility = 'hidden';menu.style.opacity = '0';menu.classList.remove('active');}}else{transportDropdown.classList.add('active');const menu = transportDropdown.querySelector('.dropdown-menu');if (menu){menu.style.display = 'block';menu.style.visibility = 'visible';menu.style.opacity = '1';menu.classList.add('active');}}});}}if (transportTrigger){transportTrigger.textContent = 'Ch·ªçn ph∆∞∆°ng th·ª©c v·∫≠n t·∫£i';transportTrigger.classList.remove('placeholder');}const defaultMode = transportModes.find(m => m.default);if (defaultMode){setTimeout(() =>{const fullDefaultMode = route.transport_modes.find(m => m.value === defaultMode.value);this.selectTransportMode(fullDefaultMode || defaultMode, routeKey);}, 300);}console.log('‚úì Transport modes populated successfully');}, selectTransportMode: function(mode, routeKey){console.log(`üö¢ Transport mode selected: ${mode.label}`);const transportDropdown = document.getElementById('transport_mode_dropdown');const valueSpan = transportDropdown?.querySelector('.dropdown-value');if (valueSpan){valueSpan.textContent = mode.label;valueSpan.classList.remove('placeholder');}const hiddenInput = document.getElementById('transport_mode_input');if (hiddenInput){hiddenInput.value = mode.value;}transportDropdown?.querySelectorAll('.dropdown-option').forEach(opt =>{opt.classList.remove('selected');if (opt.getAttribute('data-value') === mode.value){opt.classList.add('selected');}});transportDropdown?.classList.remove('active');SmartInputState.selectedTransportMode = mode.value;this.populatePortOptions(mode, routeKey);}, populatePortOptions: function(mode, routeKey){console.log('üîç populatePortOptions called with mode:', mode);if (!mode.routes || mode.routes.length === 0){console.warn('‚ö†Ô∏è No port routes available for this mode:', mode.value);return;}console.log(`‚úì Found ${mode.routes.length}port routes:`, mode.routes);const polDropdown = document.getElementById('pol_dropdown');const polMenu = document.getElementById('pol_menu') || polDropdown?.querySelector('.dropdown-menu');const polTrigger = polDropdown?.querySelector('.dropdown-value');const podDropdown = document.getElementById('pod_dropdown');const podMenu = document.getElementById('pod_menu') || podDropdown?.querySelector('.dropdown-menu');const podTrigger = podDropdown?.querySelector('.dropdown-value');if (!polMenu || !podMenu){console.error('‚ùå POL/POD menus not found');console.log('Debug info:',{polDropdown: !!polDropdown, polMenuById: !!document.getElementById('pol_menu'), polMenuByQuery: !!polDropdown?.querySelector('.dropdown-menu'), podDropdown: !!podDropdown, podMenuById: !!document.getElementById('pod_menu'), podMenuByQuery: !!podDropdown?.querySelector('.dropdown-menu')});return;}console.log(`‚úì POL/POD menus found, populating options...`);polMenu.innerHTML = '';podMenu.innerHTML = '';const uniquePOLs = [...new Set(mode.routes.map(r => r.pol))];uniquePOLs.forEach(pol =>{const polOption = document.createElement('div');polOption.className = 'dropdown-option';polOption.setAttribute('data-value', pol);polOption.setAttribute('role', 'option');polOption.textContent = pol;polOption.addEventListener('click', (e) =>{e.stopPropagation();e.preventDefault();polMenu.querySelectorAll('.dropdown-option').forEach(opt =>{opt.classList.remove('selected');});polOption.classList.add('selected');this.selectPOL(pol, mode, polDropdown, podDropdown);if (polDropdown){polDropdown.classList.remove('active');}});polMenu.appendChild(polOption);});if (polTrigger){polTrigger.textContent = 'Ch·ªçn c·∫£ng b·ªëc h√†ng';polTrigger.classList.remove('placeholder');}if (polDropdown){const polTriggerBtn = polDropdown.querySelector('.dropdown-trigger');if (polTriggerBtn){const newTrigger = polTriggerBtn.cloneNode(true);polTriggerBtn.parentNode.replaceChild(newTrigger, polTriggerBtn);newTrigger.addEventListener('click', (e) =>{e.stopPropagation();e.preventDefault();if (typeof closeAllDropdowns === 'function'){closeAllDropdowns(polDropdown.id);}else{document.querySelectorAll('.custom-dropdown.active').forEach(dd =>{if (dd !== polDropdown){dd.classList.remove('active');const menu = dd.querySelector('.dropdown-menu');if (menu){menu.style.display = 'none';menu.style.visibility = 'hidden';menu.style.opacity = '0';menu.classList.remove('active');}}});}const isActive = polDropdown.classList.contains('active');if (isActive){polDropdown.classList.remove('active');const menu = polDropdown.querySelector('.dropdown-menu');if (menu){menu.style.display = 'none';menu.style.visibility = 'hidden';menu.style.opacity = '0';menu.classList.remove('active');}}else{polDropdown.classList.add('active');const menu = polDropdown.querySelector('.dropdown-menu');if (menu){menu.style.display = 'block';menu.style.visibility = 'visible';menu.style.opacity = '1';menu.classList.add('active');}}});}}if (uniquePOLs.length > 0){setTimeout(() =>{this.selectPOL(uniquePOLs[0], mode, polDropdown, podDropdown);}, 200);}}, selectPOL: function(pol, mode, polDropdown, podDropdown){console.log(`üìç POL selected: ${pol}`);const polValue = polDropdown?.querySelector('.dropdown-value');if (polValue){polValue.textContent = pol;polValue.classList.remove('placeholder');}polDropdown?.classList.remove('active');const polInput = document.getElementById('pol_input');if (polInput){polInput.value = pol;}SmartInputState.selectedPOL = pol;const matchingRoutes = mode.routes.filter(r => r.pol === pol);const podMenu = document.getElementById('pod_menu') || podDropdown?.querySelector('.dropdown-menu');const podTrigger = podDropdown?.querySelector('.dropdown-value');if (!podMenu){console.error('‚ùå POD menu not found in selectPOL');return;}console.log(`‚úì Found ${matchingRoutes.length}matching POD routes for POL: ${pol}`);podMenu.innerHTML = '';matchingRoutes.forEach(route =>{const podOption = document.createElement('div');podOption.className = 'dropdown-option';podOption.setAttribute('data-value', route.pod);let podText = route.pod;if (route.km) podText += ` ‚Ä¢ ${route.km.toLocaleString()}km`;if (route.days){podText += ` ‚Ä¢ ${route.days}ng√†y`;}else if (route.hours){podText += ` ‚Ä¢ ${route.hours}gi·ªù`;}if (route.cost) podText += ` ‚Ä¢ ${route.cost}`;podOption.innerHTML = ` <div class="port-option-content"> <div class="port-name">${podText}</div> </div> `;podOption.addEventListener('click', (e) =>{e.stopPropagation();e.preventDefault();podMenu.querySelectorAll('.dropdown-option').forEach(opt =>{opt.classList.remove('selected');});podOption.classList.add('selected');this.selectPOD(route, podDropdown);if (podDropdown){podDropdown.classList.remove('active');}});podMenu.appendChild(podOption);});console.log(`‚úÖ Successfully populated POD options into menu`);if (podDropdown){const menu = podDropdown.querySelector('.dropdown-menu') || podMenu;if (menu){menu.style.setProperty('display', 'block', 'important');menu.style.setProperty('visibility', 'visible', 'important');menu.style.setProperty('opacity', '1', 'important');menu.style.setProperty('z-index', '10003', 'important');}}if (podDropdown){const podTriggerBtn = podDropdown.querySelector('.dropdown-trigger');if (podTriggerBtn){const newTrigger = podTriggerBtn.cloneNode(true);podTriggerBtn.parentNode.replaceChild(newTrigger, podTriggerBtn);newTrigger.addEventListener('click', (e) =>{e.stopPropagation();e.preventDefault();if (typeof closeAllDropdowns === 'function'){closeAllDropdowns(podDropdown.id);}else{document.querySelectorAll('.custom-dropdown.active').forEach(dd =>{if (dd !== podDropdown){dd.classList.remove('active');const menu = dd.querySelector('.dropdown-menu');if (menu){menu.style.display = 'none';menu.style.visibility = 'hidden';menu.style.opacity = '0';menu.classList.remove('active');}}});}const isActive = podDropdown.classList.contains('active');if (isActive){podDropdown.classList.remove('active');const menu = podDropdown.querySelector('.dropdown-menu');if (menu){menu.style.display = 'none';menu.style.visibility = 'hidden';menu.style.opacity = '0';menu.classList.remove('active');}}else{podDropdown.classList.add('active');const menu = podDropdown.querySelector('.dropdown-menu');if (menu){menu.style.display = 'block';menu.style.visibility = 'visible';menu.style.opacity = '1';menu.classList.add('active');}}});}}if (podTrigger){podTrigger.textContent = 'Ch·ªçn c·∫£ng d·ª° h√†ng';podTrigger.classList.remove('placeholder');}if (matchingRoutes.length > 0){setTimeout(() =>{this.selectPOD(matchingRoutes[0], podDropdown);}, 200);}}, selectPOD: function(route, podDropdown){console.log(`üèÅ POD selected: ${route.pod}`);const podValue = podDropdown?.querySelector('.dropdown-value');if (podValue){podValue.textContent = route.pod;podValue.classList.remove('placeholder');}podDropdown?.classList.remove('active');const podInput = document.getElementById('pod_input');if (podInput){podInput.value = route.pod;}SmartInputState.selectedPOD = route.pod;if (route.km){const distanceInput = document.getElementById('distance');if (distanceInput){distanceInput.value = route.km;this.animateAutoFill(distanceInput);console.log(`‚úì Auto-filled distance: ${route.km}km`);}}if (route.days || route.hours){const transitDisplay = document.getElementById('transit_time_display');const transitHidden = document.getElementById('transit_time');if (transitDisplay){if (route.days){transitDisplay.value = `${route.days}ng√†y`;if (transitHidden) transitHidden.value = route.days;}else if (route.hours){const days = Math.ceil(route.hours / 24);transitDisplay.value = `${route.hours}gi·ªù (${days}ng√†y)`;if (transitHidden) transitHidden.value = days;}this.animateAutoFill(transitDisplay);console.log(`‚úì Auto-filled transit time: ${route.days || route.hours}`);}}}, resetTransportDependentFields: function(){const transportDropdown = document.getElementById('transport_mode_dropdown');const transportValue = transportDropdown?.querySelector('.dropdown-value');if (transportValue){transportValue.textContent = 'Ch·ªçn ph∆∞∆°ng th·ª©c v·∫≠n t·∫£i';transportValue.classList.add('placeholder');}const polDropdown = document.getElementById('pol_dropdown');const podDropdown = document.getElementById('pod_dropdown');if (polDropdown){const polValue = polDropdown.querySelector('.dropdown-value');if (polValue){polValue.textContent = 'Ch·ªçn ph∆∞∆°ng th·ª©c tr∆∞·ªõc';polValue.classList.add('placeholder');}}if (podDropdown){const podValue = podDropdown.querySelector('.dropdown-value');if (podValue){podValue.textContent = 'Ch·ªçn ph∆∞∆°ng th·ª©c tr∆∞·ªõc';podValue.classList.add('placeholder');}}const distanceInput = document.getElementById('distance');const transitDisplay = document.getElementById('transit_time_display');if (distanceInput) distanceInput.value = '';if (transitDisplay) transitDisplay.value = '';}, initCountryAutoSuggest: function(){console.log('‚úì [INIT] Country Auto-suggest activated');const sellerDropdown = document.getElementById('seller_country_dropdown') || document.querySelector('[id*="seller_country"]');const buyerDropdown = document.getElementById('buyer_country_dropdown') || document.querySelector('[id*="buyer_country"]');if (!sellerDropdown || !buyerDropdown){console.warn('‚ö†Ô∏è Country dropdowns not found, skipping auto-suggest');return;}sellerDropdown.addEventListener('change', () => this.handleCountryChange());buyerDropdown.addEventListener('change', () => this.handleCountryChange());}, handleCountryChange: function(){const sellerCountry = this.getDropdownValue('seller_country_dropdown') || this.getDropdownValue('seller_country');const buyerCountry = this.getDropdownValue('buyer_country_dropdown') || this.getDropdownValue('buyer_country');if (!sellerCountry || !buyerCountry){console.log('‚è∏Ô∏è Waiting for both countries to be selected');return;}this.autoSuggestRoute(sellerCountry, buyerCountry);}, autoSuggestRoute: function(seller, buyer){console.log(`üîç Auto-suggesting route: ${seller}‚Üí ${buyer}`);let routeKey = null;if (seller === 'vn' || seller === 'vietnam'){if (buyer === 'us' || buyer === 'united_states') routeKey = 'vn_us';else if (buyer === 'cn' || buyer === 'china') routeKey = 'vn_cn';else if (buyer === 'kr' || buyer === 'south_korea') routeKey = 'vn_kr';else if (buyer === 'jp' || buyer === 'japan') routeKey = 'vn_jp';else if (buyer === 'eu' || buyer === 'nl' || buyer === 'de' || buyer === 'europe') routeKey = 'vn_eu';else if (buyer === 'hk' || buyer === 'hong_kong') routeKey = 'vn_hk';else if (buyer === 'in' || buyer === 'india') routeKey = 'vn_in';else if (buyer === 'th' || buyer === 'thailand') routeKey = 'vn_th';else if (buyer === 'tw' || buyer === 'taiwan') routeKey = 'vn_tw';}if (seller === buyer || (seller === 'vn' && buyer === 'vn')){routeKey = 'domestic';}const LOGISTICS_DATA = SmartInputSystem.getLogisticsData();if (!LOGISTICS_DATA) return;if (routeKey && LOGISTICS_DATA.routes[routeKey]){const routeData = LOGISTICS_DATA.routes[routeKey];console.log(`‚úì Found route: ${routeData.name_vi || routeData.name}`);setTimeout(() =>{this.selectDropdownOption('route_dropdown', routeKey);SmartInputState.selectedRoute = routeKey;this.handleRouteSelection(routeKey);}, 200);}}, initPortSelectors: function(){console.log('‚úì [INIT] Port Selectors activated');}, initContainerRecommendation: function(){console.log('‚úì [INIT] Container Recommendation activated');const cargoDropdown = document.getElementById('cargo_type_dropdown') || document.querySelector('[id*="cargo_type"]');if (!cargoDropdown){console.warn('‚ö†Ô∏è Cargo type dropdown not found');return;}cargoDropdown.addEventListener('change', () => this.handleCargoTypeChange());}, handleCargoTypeChange: function(){const cargoType = this.getDropdownValue('cargo_type_dropdown') || this.getDropdownValue('cargo_type');if (!cargoType) return;console.log(`üì¶ Cargo type changed: ${cargoType}`);SmartInputState.selectedCargoType = cargoType;}, initTransitTimeCalculation: function(){console.log('‚úì [INIT] Enhanced Transit Time Calculation activated');const etdInput = document.getElementById('etd') || document.getElementById('etd_input');const etaInput = document.getElementById('eta') || document.getElementById('eta_input');const transitDisplay = document.getElementById('transit_time_display');const transitHidden = document.getElementById('transit_time');if (!etdInput || !etaInput){console.warn('‚ö†Ô∏è ETD/ETA inputs not found');return;}const updateTransitTime = () =>{if (!etdInput.value || !etaInput.value){if (transitDisplay){transitDisplay.value = '';transitDisplay.style.borderColor = '';transitDisplay.style.background = '';}if (transitHidden) transitHidden.value = '';return;}const etdDate = new Date(etdInput.value);const etaDate = new Date(etaInput.value);if (etaDate <= etdDate){if (transitDisplay){transitDisplay.value = '';transitDisplay.style.borderColor = '#ef4444';transitDisplay.style.background = 'rgba(239, 68, 68, 0.1)';}if (transitHidden) transitHidden.value = '';this.showError('eta', 'ETA ph·∫£i sau ETD');return;}const diffTime = Math.abs(etaDate - etdDate);const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));if (transitDisplay){transitDisplay.value = `${diffDays}ng√†y`;transitDisplay.style.background = 'rgba(0, 255, 136, 0.1)';transitDisplay.style.borderColor = '#00ffc3';transitDisplay.classList.add('glow-animation');setTimeout(() =>{transitDisplay.style.background = '';transitDisplay.classList.remove('glow-animation');}, 1000);}if (transitHidden){transitHidden.value = diffDays;}this.clearError('eta');console.log(`‚úì Transit time calculated: ${diffDays}days`);};etdInput.addEventListener('change', updateTransitTime);etaInput.addEventListener('change', updateTransitTime);if (etdInput.value && etaInput.value){updateTransitTime();}}, calculateTransitTime: function(){const etdInput = document.getElementById('etd') || document.getElementById('etd_input');const etaInput = document.getElementById('eta') || document.getElementById('eta_input');if (!etdInput || !etdInput.value) return;const routeKey = SmartInputState.selectedRoute;const transportMode = SmartInputState.selectedTransportMode;if (!routeKey || !transportMode) return;const LOGISTICS_DATA = window._LOGISTICS_DATA_REF || window.LOGISTICS_DATA || (typeof LOGISTICS_DATA !== 'undefined' ? LOGISTICS_DATA : null);if (!LOGISTICS_DATA){console.error('‚ùå LOGISTICS_DATA not available in handleRouteSelection');return;}const route = LOGISTICS_DATA.getRoute(routeKey);if (!route) return;const mode = route.transport_modes.find(m => m.value === transportMode);if (!mode) return;let days = 0;if (mode.days){const daysParts = mode.days.split('-').map(d => parseInt(d.trim()));days = daysParts.length > 1 ? Math.ceil((daysParts[0] + daysParts[1]) / 2) : daysParts[0];}else if (mode.hours){const hoursParts = mode.hours.split('-').map(h => parseInt(h.trim()));const avgHours = hoursParts.length > 1 ? (hoursParts[0] + hoursParts[1]) / 2 : hoursParts[0];days = Math.ceil(avgHours / 24);}if (days > 0){const etd = new Date(etdInput.value);const eta = new Date(etd);eta.setDate(eta.getDate() + days);etaInput.value = eta.toISOString().split('T')[0];this.animateAutoFill(etaInput);console.log(`üìÖ Calculated ETA: ${eta.toLocaleDateString()}(${days}days)`);}}, initClimateAutoFetch: function(){console.log('‚úì [INIT] Climate Data Auto-Fetch activated');const etdInput = document.getElementById('etd') || document.getElementById('etd_input');const etaInput = document.getElementById('eta') || document.getElementById('eta_input');const routeDropdown = document.getElementById('route_dropdown');const tryFetchClimate = () =>{const route = SmartInputState.selectedRoute;const etd = etdInput?.value;const eta = etaInput?.value;if (route && etd && eta){this.fetchClimateData(route, etd, eta);}};if (etdInput) etdInput.addEventListener('change', tryFetchClimate);if (etaInput) etaInput.addEventListener('change', tryFetchClimate);if (routeDropdown) routeDropdown.addEventListener('change', tryFetchClimate);}, async fetchClimateData(route, etd, eta){const transitMonth = new Date(etd).getMonth() + 1;const transitYear = new Date(etd).getFullYear();const startDate = new Date(etd);const endDate = new Date(eta);try{const response = await fetch('/api/climate_data',{method: 'POST', headers:{'Content-Type': 'application/json'}, body: JSON.stringify({route: route, start_date: startDate.toISOString().split('T')[0], end_date: endDate.toISOString().split('T')[0], pol: SmartInputState.selectedPOL || '', pod: SmartInputState.selectedPOD || ''})});if (!response.ok) throw new Error('Climate API failed');const climateData = await response.json();this.populateClimateFields(climateData);}catch (error){console.warn('‚ö†Ô∏è Climate API unavailable, using defaults');this.populateClimateDefaults(route, transitMonth);}}, populateClimateFields(data){const fields ={'enso_index': data.enso || 0.0, 'typhoon_frequency': data.typhoon_freq || 0.5, 'sst_anomaly': data.sst_anomaly || 0.0, 'port_climate_stress': data.port_stress || 5.0, 'climate_volatility_index': data.volatility || 50};Object.keys(fields).forEach(fieldId =>{const input = document.getElementById(fieldId);if (input){input.value = fields[fieldId];if (input.type === 'range'){input.dispatchEvent(new Event('input',{bubbles: true}));}input.style.background = 'rgba(0, 255, 136, 0.1)';setTimeout(() =>{input.style.background = '';}, 1000);}});this.showNotification('‚úì Climate data loaded from NOAA/NASA', 'success');}, populateClimateDefaults(route, month){const isTyphoonSeason = [6, 7, 8, 9, 10].includes(month);const defaults ={'enso_index': 0.0, 'typhoon_frequency': isTyphoonSeason ? 0.7 : 0.3, 'sst_anomaly': 0.0, 'port_climate_stress': 5.0, 'climate_volatility_index': isTyphoonSeason ? 65 : 45};Object.keys(defaults).forEach(fieldId =>{const input = document.getElementById(fieldId);if (input && !input.value){input.value = defaults[fieldId];if (input.type === 'range'){input.dispatchEvent(new Event('input',{bubbles: true}));}}});}, showNotification(message, type){console.log(`[${type.toUpperCase()}] ${message}`);}, initRealtimeValidation: function(){console.log('‚úì [INIT] Real-time Validation activated');const requiredFields = document.querySelectorAll('input[required], select[required]');requiredFields.forEach(field =>{field.addEventListener('blur', () => this.validateField(field));field.addEventListener('input', () =>{if (field.classList.contains('error-field')){this.validateField(field);}else{this.markFieldValid(field);}});});}, validateField: function(field){const value = field.value.trim();const isRequired = field.hasAttribute('required');if (isRequired && !value){field.classList.add('error-field');field.classList.remove('field-completed');return false;}field.classList.remove('error-field');this.markFieldValid(field);return true;}, markFieldValid: function(field){if (field.value && field.value.trim()){field.classList.add('field-completed');SmartInputState.completedFields.add(field.id);}}, showError: function(fieldId, message){const field = document.getElementById(fieldId);const errorElement = document.getElementById(fieldId + '_error') || field?.parentElement?.querySelector('.error-message');if (field){field.classList.add('error-field');field.style.borderColor = '#ef4444';}if (errorElement){errorElement.textContent = message;errorElement.style.display = 'block';}}, clearError: function(fieldId){const field = document.getElementById(fieldId);const errorElement = document.getElementById(fieldId + '_error') || field?.parentElement?.querySelector('.error-message');if (field){field.classList.remove('error-field');field.style.borderColor = '';}if (errorElement){errorElement.textContent = '';errorElement.style.display = 'none';}}, initProgressTracking: function(){console.log('‚úì [INIT] Progress Tracking activated');if (window.disableSmartProgressTracking || typeof window.scheduleProgressUpdate === 'function' || typeof window.updateProgress === 'function'){console.log('‚Ü™ Detected host progress tracker, skipping SmartInput duplicate listeners');return;}const calculateProgress = () =>{const requiredFields = document.querySelectorAll('input[required], select[required], textarea[required]');const filledFields = Array.from(requiredFields).filter(field =>{if (field.tagName === 'INPUT' && field.type !== 'checkbox'){return field.value && field.value.trim() !== '';}if (field.tagName === 'SELECT'){return field.value;}if (field.tagName === 'TEXTAREA'){return field.value && field.value.trim() !== '';}return false;});const progress = requiredFields.length > 0 ? Math.round((filledFields.length / requiredFields.length) * 100) : 0;const progressBar = document.getElementById('header_progress_bar');const progressText = document.getElementById('header_progress_text');if (progressBar){progressBar.style.width = progress + '%';}if (progressText){progressText.textContent = progress + '%';}return progress;};document.addEventListener('input', calculateProgress);document.addEventListener('change', calculateProgress);setTimeout(calculateProgress, 500);}, initSliderDisplays: function(){console.log('‚úì [INIT] Slider Displays with Dynamic Badges activated');const sliders = [{id: 'carrier_rating', format: (val) => `${parseFloat(val).toFixed(1)}‚≠ê`, bubbleFormat: (val) => `${parseFloat(val).toFixed(1)}`, interpreter: (val) => RatingInterpreter.getCarrierRating(val), benchmark: BenchmarkData.carrierRating},{id: 'weather_risk', format: (val) => `${parseFloat(val).toFixed(1)}/10`, interpreter: (val) => RatingInterpreter.getRiskRating(val), bubbleFormat: (val) => `${parseFloat(val).toFixed(1)}`, benchmark: null},{id: 'port_risk', format: (val) => `${parseFloat(val).toFixed(1)}/10`, interpreter: (val) => RatingInterpreter.getRiskRating(val), bubbleFormat: (val) => `${parseFloat(val).toFixed(1)}`, benchmark: null},{id: 'priority_level', format: (val) => `${parseInt(val)}/10`, interpreter: (val) => RatingInterpreter.getPriorityRating(val), bubbleFormat: (val) => `${parseInt(val)}`, benchmark: null},{id: 'container_match', format: (val) => `${parseFloat(val).toFixed(1)}/10`, interpreter: (val) => RatingInterpreter.getContainerMatchRating(val), bubbleFormat: (val) => `${parseFloat(val).toFixed(1)}`, benchmark: BenchmarkData.containerMatch},{id: 'seller_reliability', format: (val) => `${parseInt(val)}/100`, interpreter: (val) => RatingInterpreter.getReliabilityRating(val), bubbleFormat: (val) => `${parseInt(val)}`, benchmark: BenchmarkData.reliability},{id: 'buyer_reliability', format: (val) => `${parseInt(val)}/100`, interpreter: (val) => RatingInterpreter.getReliabilityRating(val), bubbleFormat: (val) => `${parseInt(val)}`, benchmark: BenchmarkData.reliability},{id: 'port_climate_stress', format: (val) => `${parseFloat(val).toFixed(1)}/10`, interpreter: (val) => RatingInterpreter.getRiskRating(val), bubbleFormat: (val) => `${parseFloat(val).toFixed(1)}`, benchmark: BenchmarkData.portClimateStress},{id: 'climate_volatility_index', format: (val) => `${parseInt(val)}/100`, interpreter: null, bubbleFormat: (val) => `${parseInt(val)}`, benchmark: BenchmarkData.climateVolatility},{id: 'climate_resilience', format: (val) => `${parseFloat(val).toFixed(1)}/10`, interpreter: null, bubbleFormat: (val) => `${parseFloat(val).toFixed(1)}`, benchmark: null},{id: 'green_packaging', format: (val) => `${parseInt(val)}%`, interpreter: null, bubbleFormat: (val) => `${parseInt(val)}%`, benchmark: null}];let initializedCount = 0;sliders.forEach(slider =>{const input = document.getElementById(slider.id);const display = document.getElementById(`${slider.id}_display`);if (!input || input.type !== 'range'){return;}if (!display){return;}const formGroup = input?.closest('.form-group');if (input && display){const minValue = parseFloat(input.min) || 0;const maxValue = parseFloat(input.max) || 100;const sliderRange = maxValue - minValue;const numberInput = document.getElementById(`${slider.id}_number`);let dynamicBadge = formGroup?.querySelector('.dynamic-badge');if (!dynamicBadge && slider.interpreter){dynamicBadge = document.createElement('span');dynamicBadge.className = 'dynamic-badge';dynamicBadge.setAttribute('data-value', input.value);display.parentNode.insertBefore(dynamicBadge, display.nextSibling);}const shouldShowBubble = !input.classList.contains('slider-hidden') && (sliderRange > 20 || !!numberInput);let valueBubble = null;if (shouldShowBubble){valueBubble = formGroup?.querySelector('.slider-value-bubble');if (!valueBubble){valueBubble = document.createElement('div');valueBubble.className = 'slider-value-bubble';formGroup?.appendChild(valueBubble);}}let benchmarkHint = formGroup?.querySelector('.benchmark-hint');if (!benchmarkHint && slider.benchmark){benchmarkHint = document.createElement('div');benchmarkHint.className = 'benchmark-hint';formGroup.appendChild(benchmarkHint);}const currentValue = input.value || input.getAttribute('value') || input.defaultValue || '0';display.textContent = slider.format(currentValue);const updateBadge = (value) =>{if (dynamicBadge && slider.interpreter){const rating = slider.interpreter(value);dynamicBadge.className = `dynamic-badge ${rating.class}`;dynamicBadge.setAttribute('data-value', value);dynamicBadge.innerHTML = ` <span class="badge-icon">${rating.icon}</span> <span class="badge-text">${rating.label}</span> `;dynamicBadge.style.transform = 'scale(1.05)';setTimeout(() =>{dynamicBadge.style.transform = 'scale(1)';}, 150);}};const updateBenchmark = (value) =>{if (benchmarkHint && slider.benchmark){const num = parseFloat(value);const avg = slider.benchmark.industryAvg || slider.benchmark.isoStandard || slider.benchmark.noaaAlert;const diff = num - avg;const diffText = diff >= 0 ? `+${diff.toFixed(0)}` : diff.toFixed(0);const comparison = diff >= 0 ? 'Above' : 'Below';const benchmarkLabel = slider.benchmark.industryAvg ? 'Industry Avg' : slider.benchmark.isoStandard ? 'ISO Standard' : slider.benchmark.noaaAlert ? 'NOAA Alert' : 'Benchmark';benchmarkHint.innerHTML = ` <span class="benchmark-marker">${benchmarkLabel}: ${avg}</span> <span class="benchmark-marker">Your Score: ${num.toFixed(1)}(${comparison}${Math.abs(diff).toFixed(0)})</span> `;}};const updateValueBubble = (value) =>{if (!valueBubble) return;const numericValue = parseFloat(value) || 0;const percent = ((numericValue - minValue) / (maxValue - minValue)) * 100;const bubbleFormatter = slider.bubbleFormat || ((val) =>{const step = parseFloat(input.step) || 1;return step < 1 ? parseFloat(val).toFixed(1) : parseFloat(val).toFixed(0);});valueBubble.textContent = bubbleFormatter(value);const sliderRect = input.getBoundingClientRect();const groupRect = formGroup?.getBoundingClientRect();if (!groupRect.width || !sliderRect.width) return;const sliderOffsetLeft = sliderRect.left - groupRect.left;const sliderOffsetTop = sliderRect.top - groupRect.top;const clampedPercent = Math.min(Math.max(percent, 0), 100) / 100;const bubbleLeft = sliderOffsetLeft + clampedPercent * sliderRect.width;valueBubble.style.left = `${bubbleLeft}px`;valueBubble.style.top = `${sliderOffsetTop - 36}px`;};const updateNumberInput = (value) =>{if (!numberInput) return;numberInput.value = Math.round(parseFloat(value) || 0);};const updateDisplay = (e) =>{const value = e ? e.target.value : input.value;display.textContent = slider.format(value);updateBadge(value);updateBenchmark(value);updateValueBubble(value);updateNumberInput(value);};updateBadge(currentValue);updateBenchmark(currentValue);updateValueBubble(currentValue);updateNumberInput(currentValue);input.addEventListener('input', updateDisplay);input.addEventListener('change', updateDisplay);input.addEventListener('mousemove', (e) =>{if (e.buttons === 1){updateDisplay(e);}});if (numberInput){numberInput.addEventListener('input', (e) =>{let newValue = parseFloat(e.target.value);if (isNaN(newValue)) newValue = minValue;newValue = Math.min(maxValue, Math.max(minValue, newValue));input.value = newValue;input.dispatchEvent(new Event('input',{bubbles: true}));});}initializedCount++;console.log(`‚úÖ Slider display initialized: ${slider.id}‚Üí ${display.id}`);}});console.log(`‚úÖ Slider displays: ${initializedCount}/${sliders.length}initialized`);if (initializedCount > 0 && initializedCount < sliders.length){setTimeout(() =>{console.log('üîÑ Retrying slider initialization for missing elements...');this.initSliderDisplays();}, 500);}else if (initializedCount === 0){console.log('‚ÑπÔ∏è No slider displays found in DOM - this is normal if sliders were removed during refactor');}}, initStarRating: function(){const slider = document.getElementById('carrier_rating');const starContainer = document.getElementById('carrier_rating_stars');if (!slider || slider.type !== 'range'){return;}if (!starContainer){return;}const stars = starContainer.querySelectorAll('.star');if (stars.length === 0){return;}const updateStars = (value) =>{stars.forEach(star =>{const starValue = parseInt(star.getAttribute('data-value'), 10);if (starValue <= value){star.classList.add('active');}else{star.classList.remove('active');}});};stars.forEach(star =>{star.addEventListener('click', () =>{const starValue = parseInt(star.getAttribute('data-value'), 10);slider.value = starValue;slider.dispatchEvent(new Event('input',{bubbles: true}));});});slider.addEventListener('input', () =>{updateStars(parseFloat(slider.value) || 0);});updateStars(parseFloat(slider.value) || 0);}, initCollapsibleSections: function(){console.log('‚úì [INIT] Collapsible Sections activated');const sections = document.querySelectorAll('.form-section.collapsible');sections.forEach(section =>{const header = section.querySelector('.section-header');if (header){header.addEventListener('click', () =>{this.toggleSection(section);});}});}, toggleSection: function(section){const content = section.querySelector('.section-content');const icon = section.querySelector('.collapse-icon');if (!content) return;const isCollapsed = content.classList.contains('collapsed') || content.style.display === 'none' || window.getComputedStyle(content).display === 'none';if (isCollapsed){content.classList.remove('collapsed');content.style.display = '';if (icon) icon.style.transform = 'rotate(180deg)';}else{content.classList.add('collapsed');content.style.display = 'none';if (icon) icon.style.transform = 'rotate(0deg)';}console.log(`‚úì Section ${section.id}toggled:`, isCollapsed ? 'expanded' : 'collapsed');}, initSmartDefaults: function(){console.log('‚úì [INIT] Smart Defaults activated');}, initConditionalFields: function(){console.log('‚úì [INIT] Conditional Fields activated');}, initTooltips: function(){console.log('‚úì [INIT] Tooltip System activated');const tooltipData ={'carrier_rating':{title: 'Carrier Rating', content: 'Rate the reliability and performance of your shipping carrier. Higher ratings indicate better on-time delivery, fewer damages, and superior customer service.', benchmarks: 'Industry Average: 3.5/5.0'}, 'weather_risk':{title: 'Weather Risk Assessment', content: 'Evaluate potential weather-related delays. Consider seasonal patterns, typhoon seasons, and historical weather data for your route.', benchmarks: 'Low (1-3): Favorable | Moderate (3-6): Normal | High (6-8): Monitor | Extreme (8-10): Delay Recommended'}, 'port_risk':{title: 'Port Risk Level', content: 'Assess port infrastructure, congestion, labor disputes, and security concerns. Higher risk may require alternative routing or additional insurance.', benchmarks: 'Safe (1-3) | Moderate (3-6) | Dangerous (6-8) | Critical (8-10)'}, 'priority_level':{title: 'Shipment Priority', content: 'Set priority based on delivery urgency, customer importance, and cargo value. Higher priority may incur premium shipping costs.', benchmarks: 'Low (1-4) | High (5-7) | Highest (8-10)'}, 'container_match':{title: 'Container Suitability', content: 'How well your cargo fits the selected container type. Optimal match reduces damage risk and maximizes space utilization.', benchmarks: 'ISO Standard: 8.0+ | Optimal: 9.0+ | Minimum: 6.0'}, 'seller_reliability':{title: 'Seller Reliability Score', content: 'Historical performance of the seller including on-time shipments, quality consistency, and communication reliability.', benchmarks: 'Industry Average: 65/100 | Excellent: 85+ | Poor: <30'}, 'buyer_reliability':{title: 'Buyer Reliability Score', content: 'Buyer payment history, order fulfillment rate, and dispute resolution. Higher scores indicate more reliable partners.', benchmarks: 'Industry Average: 65/100 | Excellent: 85+ | Poor: <30'}, 'port_climate_stress':{title: 'Port Climate Stress', content: 'NOAA climate data indicating port vulnerability to extreme weather, sea level rise, and climate-related disruptions.', benchmarks: 'NOAA Alert Threshold: 7.0 | Critical: 8.5+ | Safe: <4.0'}, 'climate_volatility_index':{title: 'Climate Volatility Index', content: 'Measure of climate variability affecting shipping routes. Higher values indicate more unpredictable weather patterns.', benchmarks: 'Stable: <30 | Moderate: 30-70 | High: >70'}, 'climate_resilience':{title: 'Climate Resilience Score', content: 'Port and route ability to withstand and recover from climate-related disruptions. Higher scores indicate better infrastructure.', benchmarks: 'Weak (1-4) | Moderate (4-7) | Strong (7-10)'}, 'green_packaging':{title: 'Green Packaging Percentage', content: 'Percentage of packaging materials that are recyclable, biodegradable, or sustainably sourced. Higher values improve ESG scores.', benchmarks: 'Target: 50%+ | Excellent: 80%+ | Industry Standard: 30%'}};let tooltipContainer = document.getElementById('tooltip-container');if (!tooltipContainer){tooltipContainer = document.createElement('div');tooltipContainer.id = 'tooltip-container';tooltipContainer.className = 'tooltip-container';document.body.appendChild(tooltipContainer);}Object.keys(tooltipData).forEach(sliderId =>{const slider = document.getElementById(sliderId);if (!slider) return;const formGroup = slider.closest('.form-group');if (!formGroup) return;const label = formGroup.querySelector('.form-label');if (!label) return;if (label.querySelector('.tooltip-icon')) return;const tooltipIcon = document.createElement('span');tooltipIcon.className = 'tooltip-icon';tooltipIcon.innerHTML = '‚ìò';tooltipIcon.setAttribute('data-tooltip', sliderId);tooltipIcon.setAttribute('aria-label', 'More information');label.appendChild(tooltipIcon);tooltipIcon.addEventListener('mouseenter', (e) =>{this.showTooltip(e, tooltipData[sliderId]);});tooltipIcon.addEventListener('mouseleave', () =>{this.hideTooltip();});});}, showTooltip: function(event, data){const tooltipContainer = document.getElementById('tooltip-container');if (!tooltipContainer) return;tooltipContainer.innerHTML = ` <div class="tooltip-content"> <div class="tooltip-header"> <h4>${data.title}</h4> </div> <div class="tooltip-body"> <p>${data.content}</p> ${data.benchmarks ? `<div class="tooltip-benchmark">üìä ${data.benchmarks}</div>` : ''}</div> </div> `;tooltipContainer.style.display = 'block';const rect = event.target.getBoundingClientRect();const tooltipRect = tooltipContainer.getBoundingClientRect();let top = rect.top - tooltipRect.height - 10;let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);if (left < 10) left = 10;if (left + tooltipRect.width > window.innerWidth - 10){left = window.innerWidth - tooltipRect.width - 10;}if (top < 10){top = rect.bottom + 10;}tooltipContainer.style.top = top + 'px';tooltipContainer.style.left = left + 'px';}, hideTooltip: function(){const tooltipContainer = document.getElementById('tooltip-container');if (tooltipContainer){tooltipContainer.style.display = 'none';}}, initPresetButtons: function(){console.log('‚úì [INIT] Preset Buttons activated');const presets ={conservative:{carrier_rating: 5, weather_risk: 3.0, port_risk: 3.0, priority_level: 8, container_match: 9.0, seller_reliability: 85, buyer_reliability: 85}, balanced:{carrier_rating: 4, weather_risk: 5.0, port_risk: 5.0, priority_level: 5, container_match: 7.0, seller_reliability: 65, buyer_reliability: 65}, aggressive:{carrier_rating: 2, weather_risk: 7.0, port_risk: 7.0, priority_level: 3, container_match: 5.0, seller_reliability: 45, buyer_reliability: 45}};const advancedParamsSection = document.getElementById('advanced-params');if (!advancedParamsSection) return;let presetContainer = advancedParamsSection.querySelector('.preset-buttons-container');if (!presetContainer){presetContainer = document.createElement('div');presetContainer.className = 'preset-buttons-container';const sectionHeader = advancedParamsSection.querySelector('.section-header');if (sectionHeader){sectionHeader.insertAdjacentElement('afterend', presetContainer);}}presetContainer.innerHTML = ` <div class="preset-buttons"> <button type="button" class="preset-btn conservative" data-preset="conservative"> <span class="preset-icon">üõ°Ô∏è</span> <span class="preset-label">Conservative</span> <span class="preset-desc">Low risk, high reliability</span> </button> <button type="button" class="preset-btn balanced active" data-preset="balanced"> <span class="preset-icon">‚öñÔ∏è</span> <span class="preset-label">Balanced</span> <span class="preset-desc">Standard settings</span> </button> <button type="button" class="preset-btn aggressive" data-preset="aggressive"> <span class="preset-icon">‚ö°</span> <span class="preset-label">Aggressive</span> <span class="preset-desc">Cost-optimized</span> </button> </div> `;presetContainer.querySelectorAll('.preset-btn').forEach(btn =>{btn.addEventListener('click', (e) =>{const presetName = e.currentTarget.getAttribute('data-preset');this.applyPreset(presets[presetName]);presetContainer.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));e.currentTarget.classList.add('active');});});}, applyPreset: function(preset){console.log('üìã Applying preset:', preset);Object.keys(preset).forEach(sliderId =>{const slider = document.getElementById(sliderId);if (!slider) return;const value = preset[sliderId];slider.value = value;const event = new Event('input',{bubbles: true});slider.dispatchEvent(event);slider.style.transform = 'scale(1.02)';setTimeout(() =>{slider.style.transform = 'scale(1)';}, 200);});this.showNotification('Preset applied successfully', 'success');}, showNotification: function(message, type = 'info'){const notification = document.createElement('div');notification.className = `notification notification-${type}`;notification.textContent = message;document.body.appendChild(notification);setTimeout(() =>{notification.classList.add('show');}, 10);setTimeout(() =>{notification.classList.remove('show');setTimeout(() =>{notification.remove();}, 300);}, 3000);}, initSectionEnhancements: function(){console.log('‚úì [INIT] Section Enhancements activated');this.initVerifiedBadges();this.initRiskHeatmap();this.initCompanySizeIcons();}, initVerifiedBadges: function(){const sellerReliability = document.getElementById('seller_reliability');const buyerReliability = document.getElementById('buyer_reliability');const addVerifiedBadge = (slider, sectionId) =>{if (!slider) return;const formGroup = slider.closest('.form-group');if (!formGroup) return;const section = document.getElementById(sectionId);if (!section) return;const updateBadge = () =>{const value = parseInt(slider.value);let badge = section.querySelector('.verified-badge');if (value >= 90){if (!badge){badge = document.createElement('div');badge.className = 'verified-badge';badge.innerHTML = ` <span class="verified-icon">‚úì</span> <span class="verified-text">Verified Supplier</span> `;const sectionHeader = section.querySelector('.section-header');if (sectionHeader){sectionHeader.appendChild(badge);}}badge.style.display = 'flex';}else if (badge){badge.style.display = 'none';}};slider.addEventListener('input', updateBadge);slider.addEventListener('change', updateBadge);updateBadge();};addVerifiedBadge(sellerReliability, 'seller-info');addVerifiedBadge(buyerReliability, 'buyer-info');}, initRiskHeatmap: function(){const advancedSection = document.getElementById('advanced-params');if (!advancedSection) return;const heatmapContainer = document.createElement('div');heatmapContainer.className = 'risk-heatmap-container';heatmapContainer.innerHTML = ` <div class="risk-heatmap-header"> <span class="heatmap-icon">üî•</span> <span class="heatmap-title">Overall Risk Assessment</span> </div> <div class="risk-heatmap"> <div class="heatmap-bar"> <div class="heatmap-fill" id="risk_heatmap_fill"></div> </div> <div class="heatmap-label" id="risk_heatmap_label">Calculating...</div> </div> `;const formGrid = advancedSection.querySelector('.form-grid');if (formGrid){formGrid.insertAdjacentElement('beforebegin', heatmapContainer);}const calculateRisk = () =>{const weatherRisk = parseFloat(document.getElementById('weather_risk')?.value || 5);const portRisk = parseFloat(document.getElementById('port_risk')?.value || 5);const carrierRating = parseFloat(document.getElementById('carrier_rating')?.value || 3);const containerMatch = parseFloat(document.getElementById('container_match')?.value || 7);const carrierRisk = 10 - (carrierRating * 2);const containerRisk = 10 - containerMatch;const overallRisk = ( weatherRisk * 0.3 + portRisk * 0.3 + carrierRisk * 0.2 + containerRisk * 0.2 );const fill = document.getElementById('risk_heatmap_fill');const label = document.getElementById('risk_heatmap_label');if (fill && label){const percentage = (overallRisk / 10) * 100;fill.style.width = percentage + '%';let riskLevel, riskColor;if (overallRisk >= 7.5){riskLevel = 'Extreme Risk';riskColor = '#dc2626';}else if (overallRisk >= 6.0){riskLevel = 'High Risk';riskColor = '#ef4444';}else if (overallRisk >= 4.0){riskLevel = 'Moderate Risk';riskColor = '#fbbf24';}else{riskLevel = 'Low Risk';riskColor = '#10b981';}fill.style.background = `linear-gradient(90deg, ${riskColor}, ${riskColor}dd)`;label.textContent = `${overallRisk.toFixed(1)}/10 - ${riskLevel}`;label.style.color = riskColor;}};['weather_risk', 'port_risk', 'carrier_rating', 'container_match'].forEach(id =>{const slider = document.getElementById(id);if (slider){slider.addEventListener('input', calculateRisk);slider.addEventListener('change', calculateRisk);}});setTimeout(calculateRisk, 500);}, initCompanySizeIcons: function(){const sizeDropdowns = [{id: 'seller_size_dropdown', icon: 'üè¢'},{id: 'buyer_size_dropdown', icon: 'üè¢'}];const sizeIcons ={'SME': 'üè¢', 'Small/Medium': 'üè¢', 'Medium': 'üè≠', 'Medium Enterprise': 'üè≠', 'Large': 'üåê', 'Large Corporation': 'üåê'};sizeDropdowns.forEach(({id, defaultIcon}) =>{const dropdown = document.getElementById(id);if (!dropdown) return;const trigger = dropdown.querySelector('.dropdown-trigger');if (!trigger) return;const updateIcon = () =>{const value = this.getDropdownValue(id);const icon = sizeIcons[value] || defaultIcon;let iconElement = trigger.querySelector('.size-icon');if (!iconElement){iconElement = document.createElement('span');iconElement.className = 'size-icon';trigger.insertBefore(iconElement, trigger.firstChild);}iconElement.textContent = icon;};dropdown.addEventListener('change', updateIcon);updateIcon();});}, initCopyPreviousShipment: function(){console.log('‚úì [INIT] Copy Previous Shipment (stub)');}, initMobileOptimization: function(){console.log('‚úì [INIT] Mobile Optimization activated');}, initEnhancedDemoMode: function(){console.log('‚úì [INIT] Enhanced Demo Mode activated');}, initProgressRings: function(){console.log('‚úì [INIT] Progress Rings activated');const metrics = [{id: 'seller_reliability', label: 'Seller', max: 100},{id: 'buyer_reliability', label: 'Buyer', max: 100},{id: 'carrier_rating', label: 'Carrier', max: 5, multiplier: 20},{id: 'container_match', label: 'Container', max: 10, multiplier: 10}];const advancedSection = document.getElementById('advanced-params');if (!advancedSection) return;let ringsContainer = advancedSection.querySelector('.progress-ring-container');if (!ringsContainer){ringsContainer = document.createElement('div');ringsContainer.className = 'progress-ring-container';const sectionHeader = advancedSection.querySelector('.section-header');if (sectionHeader){sectionHeader.insertAdjacentElement('afterend', ringsContainer);}}ringsContainer.innerHTML = '';metrics.forEach(metric =>{const ring = this.createProgressRing(metric);ringsContainer.appendChild(ring);});metrics.forEach(metric =>{const slider = document.getElementById(metric.id);if (slider){const updateRing = () =>{const value = slider.value || slider.getAttribute('value') || slider.defaultValue || '0';this.updateProgressRing(metric.id, value, metric);};slider.removeEventListener('input', updateRing);slider.removeEventListener('change', updateRing);slider.addEventListener('input', updateRing);slider.addEventListener('change', updateRing);setTimeout(() =>{updateRing();}, 100);}else{console.warn(`‚ö†Ô∏è Slider not found for progress ring: ${metric.id}`);}});}, createProgressRing: function(metric){const ring = document.createElement('div');ring.className = 'progress-ring';ring.id = `ring_${metric.id}`;const circumference = 2 * Math.PI * 35;ring.innerHTML = ` <svg width="80" height="80"> <circle class="progress-ring-circle progress-ring-bg" cx="40" cy="40" r="35" /> <circle class="progress-ring-circle progress-ring-fill" cx="40" cy="40" r="35" stroke-dasharray="${circumference}" stroke-dashoffset="${circumference}" /> </svg> <div class="progress-ring-label"> <span class="progress-ring-value" id="ring_value_${metric.id}">0</span> <span class="progress-ring-title">${metric.label}</span> </div> `;return ring;}, updateProgressRing: function(sliderId, value, metric){const ringId = `ring_${sliderId}`;const ring = document.getElementById(ringId);if (!ring){console.warn(`‚ö†Ô∏è Progress ring not found: ${ringId}`);return;}const fill = ring.querySelector('.progress-ring-fill');const valueLabel = document.getElementById(`ring_value_${sliderId}`);if (!fill || !valueLabel){console.warn(`‚ö†Ô∏è Progress ring elements not found for: ${sliderId}`);return;}const numValue = parseFloat(value) || 0;const percentage = (numValue / metric.max) * 100;const circumference = 2 * Math.PI * 35;const offset = circumference - (percentage / 100) * circumference;fill.style.strokeDashoffset = offset;if (metric.max === 5){valueLabel.textContent = numValue.toFixed(1);}else if (metric.max === 10){valueLabel.textContent = numValue.toFixed(1);}else{valueLabel.textContent = Math.round(numValue).toString();}if (percentage >= 85){fill.style.stroke = '#10b981';valueLabel.style.color = '#10b981';}else if (percentage >= 60){fill.style.stroke = '#3b82f6';valueLabel.style.color = '#3b82f6';}else if (percentage >= 40){fill.style.stroke = '#fbbf24';valueLabel.style.color = '#fbbf24';}else{fill.style.stroke = '#ef4444';valueLabel.style.color = '#ef4444';}}, initSparklines: function(){console.log('‚úì [INIT] Sparkline Charts activated');const climateSection = document.getElementById('climate-esg');if (!climateSection) return;const volatilityInput = document.getElementById('climate_volatility_index');if (!volatilityInput) return;const formGroup = volatilityInput.closest('.form-group');if (!formGroup) return;let sparklineContainer = formGroup.querySelector('.sparkline-container');if (!sparklineContainer){sparklineContainer = document.createElement('div');sparklineContainer.className = 'sparkline-container';formGroup.appendChild(sparklineContainer);}const generateSparklineData = () =>{const baseValue = parseFloat(volatilityInput.value) || 50;const data = [];for (let i = 0;i < 12;i++){data.push(baseValue + (Math.random() - 0.5) * 20);}return data;};const drawSparkline = (data) =>{const width = 200;const height = 40;const padding = 4;const max = Math.max(...data, 100);const min = Math.min(...data, 0);const range = max - min || 1;const points = data.map((value, index) =>{const x = (index / (data.length - 1)) * (width - padding * 2) + padding;const y = height - ((value - min) / range) * (height - padding * 2) - padding;return `${x},${y}`;}).join(' ');sparklineContainer.innerHTML = ` <div class="sparkline-header"> <span class="sparkline-label">12-Month Trend</span> </div> <svg width="${width}" height="${height}" class="sparkline-svg"> <polyline points="${points}" fill="none" stroke="url(#sparklineGradient)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /> <defs> <linearGradient id="sparklineGradient" x1="0%" y1="0%" x2="100%" y2="0%"> <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" /> <stop offset="100%" style="stop-color:#10b981;stop-opacity:1" /> </linearGradient> </defs> </svg> `;};drawSparkline(generateSparklineData());volatilityInput.addEventListener('change', () =>{drawSparkline(generateSparklineData());});}, initPresetExportImport: function(){console.log('‚úì [INIT] Preset Export/Import activated');const advancedSection = document.getElementById('advanced-params');if (!advancedSection) return;let presetContainer = advancedSection.querySelector('.preset-buttons-container');if (!presetContainer) return;const exportImportContainer = document.createElement('div');exportImportContainer.className = 'preset-export-import';exportImportContainer.innerHTML = ` <button type="button" class="export-btn" id="export_preset_btn" title="Export current settings"> <span>üíæ</span> Export </button> <button type="button" class="import-btn" id="import_preset_btn" title="Import saved settings"> <span>üì•</span> Import </button> <input type="file" id="import_preset_file" accept=".json" style="display: none;"> `;presetContainer.appendChild(exportImportContainer);document.getElementById('export_preset_btn')?.addEventListener('click', () =>{this.exportPreset();});document.getElementById('import_preset_btn')?.addEventListener('click', () =>{document.getElementById('import_preset_file')?.click();});document.getElementById('import_preset_file')?.addEventListener('change', (e) =>{this.importPreset(e);});}, exportPreset: function(){const sliders = [ 'carrier_rating', 'weather_risk', 'port_risk', 'priority_level', 'container_match', 'seller_reliability', 'buyer_reliability' ];const preset ={};sliders.forEach(id =>{const slider = document.getElementById(id);if (slider){preset[id] = parseFloat(slider.value);}});const dataStr = JSON.stringify(preset, null, 2);const dataBlob = new Blob([dataStr],{type: 'application/json'});const url = URL.createObjectURL(dataBlob);const link = document.createElement('a');link.href = url;link.download = `riskcast-preset-${new Date().toISOString().split('T')[0]}.json`;link.click();URL.revokeObjectURL(url);this.showNotification('Preset exported successfully', 'success');}, importPreset: function(event){const file = event.target.files[0];if (!file) return;const reader = new FileReader();reader.onload = (e) =>{try{const preset = JSON.parse(e.target.result);this.applyPreset(preset);this.showNotification('Preset imported successfully', 'success');}catch (error){this.showNotification('Invalid preset file', 'error');console.error('Import error:', error);}};reader.readAsText(file);event.target.value = '';}, initKeyboardShortcuts: function(){console.log('‚úì [INIT] Keyboard Shortcuts activated');document.addEventListener('keydown', (e) =>{if ((e.ctrlKey || e.metaKey) && e.key === 's'){e.preventDefault();this.exportPreset();}if ((e.ctrlKey || e.metaKey) && e.key === 'o'){e.preventDefault();document.getElementById('import_preset_file')?.click();}if ((e.ctrlKey || e.metaKey) && ['1', '2', '3'].includes(e.key)){e.preventDefault();const presetMap ={'1': 'conservative', '2': 'balanced', '3': 'aggressive'};const presetName = presetMap[e.key];const presetBtn = document.querySelector(`[data-preset="${presetName}"]`);presetBtn?.click();}if (e.key === 'Escape'){this.hideTooltip();document.querySelectorAll('.custom-dropdown.active').forEach(dd =>{dd.classList.remove('active');});}});setTimeout(() =>{console.log('‚å®Ô∏è Keyboard Shortcuts: Ctrl+S (Export), Ctrl+O (Import), Ctrl+1-3 (Presets)');}, 2000);}, getDropdownValue: function(dropdownId){const dropdown = document.getElementById(dropdownId);if (!dropdown) return null;const hiddenInput = document.getElementById(dropdownId.replace('_dropdown', '_input'));if (hiddenInput && hiddenInput.value){return hiddenInput.value;}const selectedOption = dropdown.querySelector('.dropdown-option.selected');if (selectedOption){return selectedOption.getAttribute('data-value');}return dropdown.value || null;}, selectDropdownOption: function(dropdownId, value){const dropdown = document.getElementById(dropdownId);if (!dropdown) return;if (dropdown.tagName === 'SELECT'){dropdown.value = value;const event = new Event('change',{bubbles: true});dropdown.dispatchEvent(event);}else{const option = dropdown.querySelector(`.dropdown-option[data-value="${value}"]`);if (option){option.click();}}}, animateAutoFill: function(element){element.style.transition = 'all 0.5s ease';element.style.backgroundColor = 'rgba(0, 255, 136, 0.2)';element.style.borderColor = '#00ffc3';setTimeout(() =>{element.style.backgroundColor = 'rgba(0, 255, 136, 0.05)';}, 1000);}};function toggleSection(sectionId){const section = document.getElementById(sectionId);if (!section){console.warn('‚ö†Ô∏è Section not found:', sectionId);return;}SmartInputSystem.toggleSection(section);}document.addEventListener('DOMContentLoaded', function(){if (window.__SMART_INPUT_INITIALIZED__ && SmartInputState.initialized){console.warn('[SmartInput] Already initialized, skipping auto-init...');return;}console.log('üöÄ DOM Ready - Starting Smart Input Init...');setTimeout(() =>{const LOGISTICS_DATA = window.LOGISTICS_DATA || (typeof LOGISTICS_DATA !== 'undefined' ? LOGISTICS_DATA : null);if (!LOGISTICS_DATA){console.error('‚ùå LOGISTICS_DATA not loaded! Please check logistics_data.js');console.warn('‚ö†Ô∏è Retrying in 1000ms...');setTimeout(() =>{const retryData = window.LOGISTICS_DATA || (typeof LOGISTICS_DATA !== 'undefined' ? LOGISTICS_DATA : null);if (retryData){console.log('‚úÖ LOGISTICS_DATA loaded, initializing...');SmartInputSystem.init();}else{console.error('‚ùå LOGISTICS_DATA still not available after retry');}}, 1000);return;}SmartInputSystem.init();}, 300);});class SmartInputSystemClass{constructor(){this.currentSelection ={route: null, cargo: null, container: null, carrier: null};}getCompatibilityScore(cargoType, containerType){if (!window.LOGISTICS_DATA || !window.LOGISTICS_DATA.containerCompatibility){return{score: 0, status: 'unknown'};}const cargoKey = window.LOGISTICS_DATA.mapCargoTypeFromHTML(cargoType);const containerKey = window.LOGISTICS_DATA.mapContainerTypeFromHTML(containerType);const compatibility = window.LOGISTICS_DATA.containerCompatibility;if (!compatibility[cargoKey]){return{score: 0, status: 'unknown'};}const score = compatibility[cargoKey][containerKey] || 0;let status = 'excellent';if (score < 6.0) status = 'bad';else if (score < 7.5) status = 'warning';return{score, status};}getCarrierInfo(route, carrierName){if (!window.LOGISTICS_DATA || !window.LOGISTICS_DATA.carrierRatings){return null;}const carriers = window.LOGISTICS_DATA.carrierRatings[route] || [];return carriers.find(c => c.name === carrierName);}getCarrierStatus(rating){if (rating < 4.2) return 'bad';if (rating < 4.4) return 'warning';return 'excellent';}generateContainerSuggestion(cargoType, currentContainer){if (!window.LOGISTICS_DATA || !window.LOGISTICS_DATA.containerCompatibility){return null;}const cargoKey = window.LOGISTICS_DATA.mapCargoTypeFromHTML(cargoType);const currentContainerKey = window.LOGISTICS_DATA.mapContainerTypeFromHTML(currentContainer);const compatibility = window.LOGISTICS_DATA.containerCompatibility;if (!compatibility[cargoKey]) return null;const scores = compatibility[cargoKey];const currentScore = scores[currentContainerKey] || 0;let bestContainerKey = currentContainerKey;let bestScore = currentScore;Object.entries(scores).forEach(([containerKey, score]) =>{if (score > bestScore){bestScore = score;bestContainerKey = containerKey;}});const bestContainerHTML = window.LOGISTICS_DATA.mapContainerTypeToHTML(bestContainerKey);if (bestContainerKey === currentContainerKey){return{type: 'success', message: `‚úÖ Container ${currentContainer.toUpperCase()}l√† l·ª±a ch·ªçn t·ªëi ∆∞u cho lo·∫°i h√†ng n√†y (${currentScore}/10)`};}return{type: 'suggestion', message: `üí° Container hi·ªán t·∫°i: ${currentContainer.toUpperCase()}(${currentScore}/10). G·ª£i √Ω: ${bestContainerHTML.toUpperCase()}(${bestScore}/10) ph√π h·ª£p h∆°n cho ${this.getCargoDisplayName(cargoKey)}.`, suggestion: bestContainerHTML, improvement: (bestScore - currentScore).toFixed(1)};}generateCarrierSuggestion(route, currentCarrier){if (!window.LOGISTICS_DATA || !window.LOGISTICS_DATA.carrierRatings){return null;}const carriers = window.LOGISTICS_DATA.carrierRatings[route] || [];const current = carriers.find(c => c.name === currentCarrier);if (!current) return null;const best = carriers.reduce((prev, curr) => curr.rating > prev.rating ? curr : prev );if (best.name === currentCarrier){return{type: 'success', message: `‚úÖ ${currentCarrier}l√† h√£ng t√†u top-rated cho tuy·∫øn n√†y (${current.rating}‚≠ê, on-time ${current.ontime}%)`};}const avgOntime = carriers.reduce((sum, c) => sum + c.ontime, 0) / carriers.length;const ontimeDiff = current.ontime - avgOntime;if (ontimeDiff < -3){return{type: 'warning', message: `‚ö†Ô∏è ${currentCarrier}c√≥ on-time th·∫•p h∆°n trung b√¨nh tuy·∫øn ${Math.abs(ontimeDiff).toFixed(0)}%. G·ª£i √Ω: ${best.name}(${best.rating}‚≠ê, on-time ${best.ontime}%) ƒë√°ng tin h∆°n.`, suggestion: best.name, improvement: `+${(best.ontime - current.ontime).toFixed(0)}% on-time`};}return{type: 'info', message: `${currentCarrier}l√† l·ª±a ch·ªçn t·ªët. N·∫øu mu·ªën on-time cao h∆°n, th·ª≠ ${best.name}(${best.rating}‚≠ê).`, suggestion: best.name};}getContainerTooltip(containerType, cargoType){if (!window.LOGISTICS_DATA) return "Kh√¥ng c√≥ th√¥ng tin";const containerKey = window.LOGISTICS_DATA.mapContainerTypeFromHTML(containerType);const description = window.LOGISTICS_DATA.getContainerDescription(containerKey) || "Kh√¥ng c√≥ th√¥ng tin";const score = this.getCompatibilityScore(cargoType, containerType);let scoreText = "";if (score.status === 'excellent'){scoreText = "‚úÖ R·∫•t ph√π h·ª£p";}else if (score.status === 'warning'){scoreText = "‚ö†Ô∏è Ph√π h·ª£p v·ª´a ph·∫£i";}else{scoreText = "‚ùå Kh√¥ng khuy·∫øn ngh·ªã";}return ` <div class="smart-tooltip"> <strong>${containerType.toUpperCase()}</strong> <p>${description}</p> <div class="tooltip-score"> ${scoreText}(${score.score}/10) </div> </div> `;}getCarrierTooltip(route, carrierName){const carrier = this.getCarrierInfo(route, carrierName);if (!carrier) return "Kh√¥ng c√≥ th√¥ng tin";return ` <div class="smart-tooltip"> <strong>${carrier.name}</strong> <div class="tooltip-rating">‚≠ê ${carrier.rating}/5.0</div> <div class="tooltip-ontime">üì¶ On-time: ${carrier.ontime}%</div> <div class="tooltip-price">üí∞ ${carrier.price}</div> <p class="tooltip-note">${carrier.note}</p> </div> `;}updateUIFeedback(selection){this.currentSelection ={...this.currentSelection, ...selection};const{route, cargo, container, carrier}= this.currentSelection;if (cargo && container){this.highlightContainer(container, cargo);this.showContainerSuggestion(cargo, container);}if (route && carrier){this.highlightCarrier(carrier, route);this.showCarrierSuggestion(route, carrier);}}highlightContainer(container, cargo){const score = this.getCompatibilityScore(cargo, container);const element = document.querySelector(`#container-${container}`);if (!element){console.warn(`Container element not found: #container-${container}`);return;}element.classList.remove('status-excellent', 'status-warning', 'status-bad');element.classList.add(`status-${score.status}`);let badge = element.querySelector('.compatibility-badge');if (!badge){badge = document.createElement('span');badge.className = 'compatibility-badge';element.appendChild(badge);}badge.textContent = `${score.score.toFixed(1)}/10`;badge.className = `compatibility-badge status-${score.status}`;badge.style.display = 'inline-block';document.querySelectorAll(`[data-container-type="${container}"]`).forEach(el =>{el.classList.remove('status-excellent', 'status-warning', 'status-bad');el.classList.add(`status-${score.status}`);});}highlightCarrier(carrierName, route){const logisticsRoute = window.LOGISTICS_DATA ? window.LOGISTICS_DATA.mapRouteFromHTML(route) : route;const carrier = this.getCarrierInfo(logisticsRoute, carrierName);if (!carrier){console.warn(`Carrier not found: ${carrierName}for route: ${route}`);return;}const status = this.getCarrierStatus(carrier.rating);const carrierId = carrierName.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '');const element = document.querySelector(`#carrier-${carrierId}`);if (!element){const elementByData = document.querySelector(`[data-carrier-name="${carrierName}"]`);if (elementByData){elementByData.classList.remove('status-excellent', 'status-warning', 'status-bad');elementByData.classList.add(`status-${status}`);const badge = elementByData.querySelector('.rating-badge');if (badge){badge.textContent = `${carrier.rating.toFixed(1)}‚≠ê`;badge.className = `rating-badge status-${status}`;}}return;}element.classList.remove('status-excellent', 'status-warning', 'status-bad');element.classList.add(`status-${status}`);const badge = element.querySelector('.rating-badge');if (badge){badge.textContent = `${carrier.rating.toFixed(1)}‚≠ê`;badge.className = `rating-badge status-${status}`;}document.querySelectorAll(`[data-carrier-name="${carrierName}"]`).forEach(el =>{el.classList.remove('status-excellent', 'status-warning', 'status-bad');el.classList.add(`status-${status}`);});}showContainerSuggestion(cargo, container){const suggestion = this.generateContainerSuggestion(cargo, container);if (!suggestion) return;const panel = document.getElementById('container-suggestion');if (!panel) return;panel.className = `suggestion-panel ${suggestion.type}`;panel.innerHTML = ` <div class="suggestion-content"> ${suggestion.message}${suggestion.suggestion ? ` <button type="button" class="suggestion-btn" data-container-value="${suggestion.suggestion}"> ƒê·ªïi sang ${suggestion.suggestion.toUpperCase()}</button> ` : ''}</div> `;panel.style.display = 'block';if (suggestion.suggestion){const btn = panel.querySelector('.suggestion-btn');if (btn){btn.addEventListener('click', (e) =>{e.preventDefault();e.stopPropagation();e.stopImmediatePropagation();console.log('[Smart Input] Container suggestion button clicked');const result = this.applyContainerSuggestion(suggestion.suggestion);return false;}, true);}}}showCarrierSuggestion(route, carrier){const suggestion = this.generateCarrierSuggestion(route, carrier);if (!suggestion) return;const panel = document.getElementById('carrier-suggestion');if (!panel) return;panel.className = `suggestion-panel ${suggestion.type}`;panel.innerHTML = ` <div class="suggestion-content"> ${suggestion.message}${suggestion.suggestion ? ` <button type="button" class="suggestion-btn" data-carrier-value="${suggestion.suggestion}"> ƒê·ªïi sang ${suggestion.suggestion}</button> ` : ''}</div> `;panel.style.display = 'block';if (suggestion.suggestion){const btn = panel.querySelector('.suggestion-btn');if (btn){btn.addEventListener('click', (e) =>{e.preventDefault();e.stopPropagation();e.stopImmediatePropagation();console.log('[Smart Input] Carrier suggestion button clicked');const result = this.applyCarrierSuggestion(suggestion.suggestion);return false;}, true);}}}applyContainerSuggestion(containerType){console.log('[Smart Input] Applying container suggestion:', containerType);const normalizedType = containerType.toLowerCase().replace(/\s+/g, '_');console.log('[Smart Input] Normalized container type:', normalizedType);const dropdown = document.getElementById('container_dropdown');if (!dropdown){console.warn('[Smart Input] Container dropdown not found');return false;}const options = dropdown.querySelectorAll('.dropdown-option');let foundIndex = -1;let foundValue = null;options.forEach((option, index) =>{const value = option.getAttribute('data-value');if (value && value.toLowerCase() === normalizedType){foundIndex = index;foundValue = value;}});if (foundIndex >= 0 && foundValue){console.log('[Smart Input] Found container option at index:', foundIndex, 'value:', foundValue);const dropdownState = window.dropdownState?.['container_dropdown'];if (dropdownState && dropdownState.isOpen){dropdown.classList.remove('open');dropdownState.isOpen = false;}if (typeof window.selectOption === 'function'){try{window.selectOption('container_dropdown', foundValue, foundIndex);console.log('[Smart Input] Container selected via selectOption');}catch (e){console.error('[Smart Input] Error calling selectOption:', e);const option = options[foundIndex];if (option){option.click();console.log('[Smart Input] Container selected via click (fallback)');}}}else{const option = options[foundIndex];if (option){option.click();console.log('[Smart Input] Container selected via click');}}setTimeout(() =>{if (window.updateSmartInputFeedback){window.updateSmartInputFeedback();}}, 200);return false;}else{console.warn('[Smart Input] Container option not found:', normalizedType, 'Available options:', Array.from(options).map(o => o.getAttribute('data-value')));return false;}}applyCarrierSuggestion(carrierName){console.log('[Smart Input] Applying carrier suggestion:', carrierName);const dropdown = document.getElementById('carrier_dropdown');if (!dropdown){console.warn('[Smart Input] Carrier dropdown not found');return false;}const options = dropdown.querySelectorAll('.dropdown-option');let foundIndex = -1;let foundValue = null;options.forEach((option, index) =>{const value = option.getAttribute('data-value');if (value === carrierName){foundIndex = index;foundValue = value;}});if (foundIndex >= 0 && foundValue){console.log('[Smart Input] Found carrier option at index:', foundIndex, 'value:', foundValue);const dropdownState = window.dropdownState?.['carrier_dropdown'];if (dropdownState && dropdownState.isOpen){dropdown.classList.remove('open');dropdownState.isOpen = false;}if (typeof window.selectOption === 'function'){try{window.selectOption('carrier_dropdown', foundValue, foundIndex);console.log('[Smart Input] Carrier selected via selectOption');}catch (e){console.error('[Smart Input] Error calling selectOption:', e);const option = options[foundIndex];if (option){option.click();console.log('[Smart Input] Carrier selected via click (fallback)');}}}else{const option = options[foundIndex];if (option){option.click();console.log('[Smart Input] Carrier selected via click');}}setTimeout(() =>{if (window.updateSmartInputFeedback){window.updateSmartInputFeedback();}}, 200);return false;}else{console.warn('[Smart Input] Carrier option not found:', carrierName, 'Available options:', Array.from(options).map(o => o.getAttribute('data-value')));return false;}}getCargoDisplayName(cargoType){let cargoKey = cargoType;if (window.LOGISTICS_DATA && window.LOGISTICS_DATA.mapCargoTypeFromHTML){const mapped = window.LOGISTICS_DATA.mapCargoTypeFromHTML(cargoType);if (mapped !== cargoType){cargoKey = mapped;}}const names ={'thong_thuong': 'h√†ng th√¥ng th∆∞·ªùng', 'dien_tu': 'h√†ng ƒëi·ªán t·ª≠', 'thuc_pham_do_uong': 'th·ª±c ph·∫©m', 'may_mac_det_may': 'd·ªát may', 'nong_san': 'n√¥ng s·∫£n', 'hang_lanh_dong_lanh': 'h√†ng l·∫°nh', 'hoa_chat': 'h√≥a ch·∫•t', 'may_moc_thiet_bi': 'm√°y m√≥c', 'hang_de_vo': 'h√†ng d·ªÖ v·ª°', 'linh_kien_o_to': 'linh ki·ªán √¥ t√¥', 'hang_nguy_hiem_dg': 'h√†ng nguy hi·ªÉm', 'duoc_pham': 'd∆∞·ª£c ph·∫©m'};return names[cargoKey] || cargoType;}initTooltips(){const containerDropdown = document.getElementById('container_dropdown');const carrierDropdown = document.getElementById('carrier_dropdown');if (containerDropdown){containerDropdown.addEventListener('mouseenter', (e) =>{const option = e.target.closest('[data-container-type]');if (option){const containerType = option.dataset.containerType;const cargoType = this.currentSelection.cargo;if (cargoType){this.showTooltip(option, this.getContainerTooltip(containerType, cargoType));}}}, true);containerDropdown.addEventListener('mouseleave', (e) =>{if (!e.target.closest('[data-container-type]')){this.hideTooltip();}}, true);}if (carrierDropdown){carrierDropdown.addEventListener('mouseenter', (e) =>{const option = e.target.closest('[data-carrier-name]');if (option){const carrierName = option.dataset.carrierName;const route = this.currentSelection.route;if (route){this.showTooltip(option, this.getCarrierTooltip(route, carrierName));}}}, true);carrierDropdown.addEventListener('mouseleave', (e) =>{if (!e.target.closest('[data-carrier-name]')){this.hideTooltip();}}, true);}document.querySelectorAll('[data-container-type]').forEach(el =>{el.addEventListener('mouseenter', (e) =>{const containerType = e.currentTarget.dataset.containerType;const cargoType = this.currentSelection.cargo;if (cargoType){this.showTooltip(e.currentTarget, this.getContainerTooltip(containerType, cargoType));}});el.addEventListener('mouseleave', () => this.hideTooltip());});document.querySelectorAll('[data-carrier-name]').forEach(el =>{el.addEventListener('mouseenter', (e) =>{const carrierName = e.currentTarget.dataset.carrierName;const route = this.currentSelection.route;if (route){this.showTooltip(e.currentTarget, this.getCarrierTooltip(route, carrierName));}});el.addEventListener('mouseleave', () => this.hideTooltip());});}showTooltip(element, content){let tooltip = document.getElementById('smart-tooltip');if (!tooltip){tooltip = document.createElement('div');tooltip.id = 'smart-tooltip';tooltip.style.cssText = ` position: absolute;background: rgba(10, 15, 20, 0.98);border: 2px solid #10b981;border-radius: 12px;padding: 12px;max-width: 300px;z-index: 10000;box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);color: #ffffff;font-size: 13px;display: none;`;document.body.appendChild(tooltip);}tooltip.innerHTML = content;tooltip.style.display = 'block';const rect = element.getBoundingClientRect();tooltip.style.left = `${rect.left}px`;tooltip.style.top = `${rect.bottom + 10}px`;}hideTooltip(){const tooltip = document.getElementById('smart-tooltip');if (tooltip) tooltip.style.display = 'none';}}const smartInputClass = new SmartInputSystemClass();if (document.readyState === 'loading'){document.addEventListener('DOMContentLoaded', () =>{smartInputClass.initTooltips();});}else{smartInputClass.initTooltips();}if (typeof window !== 'undefined'){window.SmartInputSystem = SmartInputSystem;window.SmartInputSystemClass = SmartInputSystemClass;window.smartInputClass = smartInputClass;window.smartInput = smartInputClass;window.toggleSection = toggleSection;console.log('‚úÖ SmartInputSystem v13.0 ULTIMATE loaded successfully');console.log('‚úÖ SmartInputSystemClass loaded with advanced features');console.log('‚úÖ toggleSection function available globally');}(function(){'use strict';if (typeof window.RISKCAST === 'undefined'){window.RISKCAST ={};}if (typeof window.RISKCAST.modules === 'undefined'){window.RISKCAST.modules ={};}const InputSummaryManager ={initialized: false, init: function(){if (this.initialized) return;document.addEventListener('DOMContentLoaded', () =>{setTimeout(() =>{if (typeof updateInputSummary === 'function'){updateInputSummary();}this.setupFormWatchers();}, 500);});this.initialized = true;}, setupFormWatchers: function(){const debouncedUpdate = window.RISKCAST?.core?.utils?.debounce ? window.RISKCAST.core.utils.debounce(() =>{if (typeof updateInputSummary === 'function'){updateInputSummary();}}, 300) : () =>{if (typeof updateInputSummary === 'function'){setTimeout(() => updateInputSummary(), 100);}};const formInputs = document.querySelectorAll('input[type="text"], input[type="number"], input[type="date"], select');formInputs.forEach(input =>{input.addEventListener('change', debouncedUpdate);input.addEventListener('input', debouncedUpdate);});const dropdownValues = document.querySelectorAll('.dropdown-value');dropdownValues.forEach(dropdown =>{const observer = new MutationObserver(debouncedUpdate);observer.observe(dropdown,{childList: true, characterData: true, subtree: true});});}};class SummaryPage{constructor(){this.data = null;this.init();}async init(){await this.loadData();this.populateData();this.setupAnimations();}async loadData(){try{const lastResult = localStorage.getItem('last_result');if (lastResult){const result = JSON.parse(lastResult);this.data = this.extractSummaryData(result);console.log('‚úì Summary data loaded from localStorage');return;}const response = await fetch('/api/get_last_result');if (response.ok){const apiData = await response.json();if (apiData && !apiData.error){this.data = this.extractSummaryData(apiData);console.log('‚úì Summary data loaded from API');return;}}}catch (error){console.warn('Failed to load summary data:', error);}this.data = this.getDefaultData();}extractSummaryData(result){const shipment = result.shipment ||{};const route = shipment.route || result.route || '';let origin = shipment.origin || '';let destination = shipment.destination || '';if (!origin || !destination){const parts = route.split('_');if (parts.length >= 2){origin = this.extractPortCode(parts[0]);destination = this.extractPortCode(parts[1]);}}return{route: route, routeLabel: this.getRouteLabel(route), origin: origin, destination: destination, transportMode: shipment.transport_mode || result.transport_mode || '', transportModeLabel: this.getTransportModeLabel(shipment.transport_mode || result.transport_mode || ''), cargoType: shipment.cargo_type || result.cargo_type || '', cargoTypeLabel: this.getCargoTypeLabel(shipment.cargo_type || result.cargo_type || ''), container: result.container || shipment.container || '', containerLabel: this.getContainerLabel(result.container || shipment.container || ''), incoterm: result.incoterm || shipment.incoterm || '', incotermLabel: this.getIncotermLabel(result.incoterm || shipment.incoterm || ''), packaging: result.packaging || shipment.packaging || '', packagingLabel: this.getPackagingLabel(result.packaging || shipment.packaging || ''), distance: result.distance || shipment.distance || 0, distanceKm: (result.distance || shipment.distance || 0) > 0 ? `${(result.distance || shipment.distance || 0).toLocaleString()}km` : '-- km', transitTime: result.transit_time || shipment.transit_time || 0, transitTimeDays: (result.transit_time || shipment.transit_time || 0) > 0 ? `${result.transit_time || shipment.transit_time || 0}ng√†y` : '-- ng√†y', carrier: result.carrier || shipment.carrier || '', carrierRating: result.carrier_rating || shipment.carrier_rating || 3.0, packages: result.packages || shipment.packages || 0, cargoValue: result.cargo_value || shipment.cargo_value || 0, etd: result.etd || shipment.etd || '', eta: result.eta || shipment.eta || ''};}getDefaultData(){return{route: '', routeLabel: '--', origin: '', destination: '', transportMode: '', transportModeLabel: '--', cargoType: '', cargoTypeLabel: '--', container: '', containerLabel: '--', incoterm: '', incotermLabel: '--', packaging: '', packagingLabel: '--', distance: 0, distanceKm: '-- km', transitTime: 0, transitTimeDays: '-- ng√†y', carrier: '', carrierRating: 3.0, packages: 0, cargoValue: 0, etd: '', eta: ''};}extractPortCode(routePart){return routePart.toUpperCase();}getRouteLabel(route){const routeMap ={'vn_us': 'Vi·ªát Nam ‚Üí Hoa K·ª≥', 'vn_eu': 'Vi·ªát Nam ‚Üí Ch√¢u √Çu', 'vn_cn': 'Vi·ªát Nam ‚Üí Trung Qu·ªëc', 'vn_sg': 'Vi·ªát Nam ‚Üí Singapore', 'domestic': 'N·ªôi ƒê·ªãa'};return routeMap[route] || route || '--';}getTransportModeLabel(mode){const modeMap ={'ocean_fcl': 'V·∫≠n T·∫£i Bi·ªÉn ‚Äî FCL', 'ocean_lcl': 'V·∫≠n T·∫£i Bi·ªÉn ‚Äî LCL', 'air': 'V·∫≠n T·∫£i H√†ng Kh√¥ng', 'rail': 'V·∫≠n T·∫£i ƒê∆∞·ªùng S·∫Øt', 'road': 'ƒê∆∞·ªùng B·ªô ‚Äî Xe T·∫£i'};return modeMap[mode] || mode || '--';}getCargoTypeLabel(type){const typeMap ={'electronics': 'ƒêi·ªán T·ª≠', 'food_bev': 'Th·ª±c Ph·∫©m & ƒê·ªì U·ªëng', 'garments': 'May M·∫∑c / D·ªát May', 'agriculture': 'N√¥ng S·∫£n'};return typeMap[type] || type || '--';}getContainerLabel(container){const containerMap ={'20ft': '20ft Th∆∞·ªùng', '40ft': '40ft Th∆∞·ªùng', '40hc': '40ft Cao (High Cube)', 'reefer': 'Container L·∫°nh (Reefer)'};return containerMap[container] || container || '--';}getIncotermLabel(incoterm){return incoterm.toUpperCase() || '--';}getPackagingLabel(packaging){const packagingMap ={'poor': 'K√©m', 'medium': 'Trung B√¨nh', 'good': 'T·ªët', 'excellent': 'Xu·∫•t S·∫Øc'};return packagingMap[packaging] || packaging || '--';}populateData(){if (!this.data) return;console.log('Summary data ready:', this.data);}setupAnimations(){}}window.RISKCAST.modules.inputSummary ={manager: InputSummaryManager, SummaryPage: SummaryPage, init: () => InputSummaryManager.init()};InputSummaryManager.init();if (window.location.pathname.includes('overview') || window.location.pathname.includes('summary')){window.summaryPage = new SummaryPage();}window.InputSummaryManager = InputSummaryManager;window.SummaryPage = SummaryPage;console.log('‚úÖ RISKCAST Module: Input Summary initialized');})();